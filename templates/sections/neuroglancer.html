{% from "macros.html" import iframe_embed %}
<style>
    /* Header row layout */
    #neuron-visualization .nv-header {
    display: flex;
    align-items: center;
    justify-content: space-between;   /* push toggle to the right */
    gap: 1rem;
    }
    #neuron-visualization .nv-header h2 { margin: 0; }

    /* Toggle UI */
    .nv-theme {
    display: inline-flex;
    align-items: center;
    gap: .5rem;
    user-select: none;
    }
    .nv-theme-label { font-size: .9rem; opacity: .85; }

    /* Hide native checkbox, keep it accessible */
    .nv-toggle-input {
    position: absolute;
    opacity: 0;
    pointer-events: none;
    width: 0;
    height: 0;
    }

    /* Slider look */
    .nv-toggle {
    position: relative;
    width: 46px;
    height: 24px;
    border-radius: 9999px;
    background: #bbb;
    cursor: pointer;
    transition: background .2s ease;
    }
    .nv-toggle::after {
    content: "";
    position: absolute;
    top: 2px;
    left: 2px;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #fff;
    transition: transform .2s ease;
    }

    /* Checked state */
    .nv-toggle-input:checked + .nv-toggle { background: #4caf50; }
    .nv-toggle-input:checked + .nv-toggle::after { transform: translateX(22px); }

</style>

<!-- Neuroglancer Visualization -->
<section id="neuron-visualization">
    <div class="nv-header">
        <h2>Neuron Visualization
            <a href="#" target="_blank" class="external-link neuroglancer-link" title="Open Neuroglancer in new window">&#x29c9;</a>
            {% if youtube_url %}
            <a href="{{ youtube_url }}" target="_blank" class="external-link youtube-link" title="View YouTube video"><svg role="img" width="32" height="32" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z" fill="#CC0000"/></svg></a>
            {% endif %}
        </h2>
        <!-- Theme toggle (right side) -->
        <div class="nv-theme">
        <span class="nv-theme-label">Dark</span>
        <input id="nv-theme-toggle" type="checkbox" class="nv-toggle-input" aria-label="Toggle theme: dark / light" />
        <label for="nv-theme-toggle" class="nv-toggle" aria-hidden="true"></label>
        <span class="nv-theme-label">Light</span>
        </div>
    </div>
    {{ iframe_embed("about:blank", title="Neuroglancer Visualization", extra_class="neuroglancer-iframe") }}
</section>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const section = document.getElementById('neuron-visualization');
  const input   = document.getElementById('nv-theme-toggle');

  // Load saved or system preference
  const saved = localStorage.getItem('nvTheme') ||
                (window.matchMedia && matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark');

  // Apply
  section.setAttribute('data-theme', saved);
  input.checked = (saved === 'light');

  // Toggle handler
  input.addEventListener('change', () => {
    const mode = input.checked ? 'light' : 'dark';
    section.setAttribute('data-theme', mode);
    localStorage.setItem('nvTheme', mode);
  });
});
</script>