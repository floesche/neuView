<!-- Load external static JavaScript functions -->
<script src="static/js/neuron-page.js"></script>

<script>
$(document).ready(function() {
    // Create lookup map for precise percentage values
    var roiPreciseData = {};
    {% for roi in roi_summary %}
    roiPreciseData['{{- roi.name -}}'] = {
        inputPrecise: {{- roi.post_percentage -}},
        outputPrecise: {{- roi.pre_percentage -}}
    };
    {% endfor %}

    // Create lookup map for precise upstream connection percentages
    var uPD = {};
    {% if connectivity.upstream %}{% for partner in connectivity.upstream %}
    uPD['{{- partner.get("type", "Unknown") }} ({{- partner.get("soma_side", "") -}})'] = {{- partner.get("percentage", 0) -}};
    {% endfor %}{% endif %}

    // Create lookup map for precise downstream connection percentages
    var dPD = {};
    {% if connectivity.downstream %}{% for partner in connectivity.downstream %}
    dPD['{{- partner.get("type", "Unknown") }} ({{- partner.get("soma_side", "") -}})'] = {{- partner.get("percentage", 0) -}};
    {% endfor %}{% endif %}

    // Initialize ROI table if data exists
    {% if roi_summary and roi_summary|length > 0 %}
    // Add custom search for ROI table (checks both % In and % Out)
    $.fn.dataTable.ext.search.push(createROIPercentageFilter('roi-table'));

    // DataTable configuration matching original
    var roiTable = $('#roi-table').DataTable({
        "order": [[ 1, "desc" ]], // Sort by sum of inputs column (descending)
        "pageLength": -1, // Show all rows
        "paging": false, // Disable pagination since we're using percentage filter
        "responsive": true,
        "layout": {
          "topStart": "search",
          "topEnd": $(createROIPercentageSliderInHeader('roi-table'))
        },
        "language": {
            "search": "",
            "searchPlaceholder": "Filter",
            "info": "Filter for _TOTAL_ of _MAX_ ROIs innervated by {{ neuron_data.type }}",
            "infoEmpty": "None of the _MAX_ ROI regions innervated by {{ neuron_data.type}} match filter",
            "infoFiltered": ""
        },
        "columnDefs": [
            {
                "targets": 2, // % Input column
                "type": "num-fmt",
                "render": function(data, type, row) {
                    if (type === 'display') {
                        return data;
                    }
                    return parseFloat(data.replace('%', '')) || 0;
                }
            },
            {
                "targets": 5, // % Output column
                "type": "num-fmt",
                "render": function(data, type, row) {
                    if (type === 'display') {
                        return data;
                    }
                    return parseFloat(data.replace('%', '')) || 0;
                }
            }
        ],
        "drawCallback": function(settings) {
            calculateROICumulativePercentages(this.api(), 2, 3, roiPreciseData); // % Input and cumulative
            calculateROICumulativePercentages(this.api(), 5, 6, roiPreciseData); // % Output and cumulative
            // Debug styling after calculation
            setTimeout(function() {
                debugCumulativePercentageStyling('roi-table', 'ROI table');
            }, 100);
        },
        "initComplete": function(settings, json) {
            setupROIPercentageSlider('roi-percentage-slider', 'roi-slider-value', this.api());
        }
    });
    {% endif %}

    // Initialize upstream table if data exists
    {% if connectivity.upstream %}
    // Add custom search for upstream table only
    $.fn.dataTable.ext.search.push(createConnectionsFilter('upstream-table', 3));

    var upstreamTable = $('#upstream-table').DataTable({
        "order": [[ 2, "desc" ]], // Sort by num connections column (descending)
        "pageLength": -1, // Show all rows
        "paging": false, // Disable pagination since we're using connections filter
        "responsive": true,
        "layout":{
          "topStart": "search",
          "topEnd": $(createConnectionsSliderInHeader('upstream-table', '{{- neuron_data.type -}}'))
        },
        "language": {
            "search": "",
            "searchPlaceholder": "Filter",
            "info": "Filter for _TOTAL_ of _MAX_ input neuron types to {{ neuron_data.type }}",
            "infoEmpty": "None of the _MAX_ input neuron types to {{ neuron_data.type}} match filter",
            "infoFiltered": ""
        },
        "columnDefs": [
            {
                "targets": 4, // % of Input column
                "type": "num-fmt",
                "render": function(data, type, row) {
                    if (type === 'display') {
                        return data;
                    }
                    return parseFloat(data.replace('%', '')) || 0;
                }
            }
        ],
        "drawCallback": function(settings) {
            calculateUpstreamCumulativePercentages(this.api(), 4, 5, uPD);
            // Debug styling after calculation
            setTimeout(function() {
                debugCumulativePercentageStyling('upstream-table', 'upstream connections');
            }, 100);
        },
        "initComplete": function(settings, json) {
            // Create slider in header after table initialization
            setupConnectionsSlider('upstream-connections-slider', 'upstream-slider-value', this.api());
        }
    });
    {% endif %}

    // Initialize downstream table if data exists
    {% if connectivity.downstream %}
    // Add custom search for downstream table only
    $.fn.dataTable.ext.search.push(createConnectionsFilter('downstream-table', 3));

    var downstreamTable = $('#downstream-table').DataTable({
        "order": [[ 2, "desc" ]], // Sort by num connections column (descending)
        "pageLength": -1, // Show all rows
        "paging": false, // Disable pagination since we're using connections filter
        "responsive": true,
        "layout": {
            "topStart": "search",
            "topEnd": $(createConnectionsSliderInHeader('downstream-table', '{{- neuron_data.type -}}'))
        },
        "language": {
            "search": "",
            "searchPlaceholder": "Filter",
            "info": "Filter for _TOTAL_ of _MAX_ output neuron types to {{ neuron_data.type }}",
            "infoEmpty": "None of the _MAX_ output neuron types to {{ neuron_data.type}} match filter",
            "infoFiltered": ""
        },
        "columnDefs": [
            {
                "targets": 4, // % of Output column
                "type": "num-fmt",
                "render": function(data, type, row) {
                    if (type === 'display') {
                        return data;
                    }
                    return parseFloat(data.replace('%', '')) || 0;
                }
            }
        ],
        "drawCallback": function(settings) {
            calculateDownstreamCumulativePercentages(this.api(), 4, 5, dPD);
            // Debug styling after calculation
            setTimeout(function() {
                debugCumulativePercentageStyling('downstream-table', 'downstream connections');
            }, 100);
        },
        "initComplete": function(settings, json) {
            setupConnectionsSlider('downstream-connections-slider', 'downstream-slider-value', this.api());
        }
    });
    {% endif %}

    // Initialize all tooltip functionality
    initializeAllTooltips();
});
</script>
