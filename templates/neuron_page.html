<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>{{ config.html.title_prefix }} - {{ neuron_data.type }}</title>
        <link rel="stylesheet" href="static/css/plume-all.css" />
        <link rel="stylesheet" href="static/css/flexboxgrid.min.css" />
        <!-- DataTables CSS -->
        <link
            rel="stylesheet"
            href="static/css/dataTables.dataTables.min.css"
        />
        <link
            rel="stylesheet"
            href="static/css/dataTables.bootstrap4.min.css"
        />
        <style>
            .neuron-header {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 3rem 0;
                margin-bottom: 2rem;
                text-align: center;
            }
            .neuron-header h1 {
                font-size: 3rem;
                margin-bottom: 0.5rem;
                color: white;
            }
            .neuron-header p {
                opacity: 0.9;
                margin: 0.5rem 0;
            }
            .stat-card {
                background: white;
                border-radius: 12px;
                padding: 2rem;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                margin-bottom: 1rem;
                text-align: center;
                border: 1px solid #e5e7eb;
            }
            .stat-number {
                font-size: 2.5rem;
                font-weight: bold;
                color: #667eea;
                margin-bottom: 0.5rem;
            }
            .data-table {
                background: white;
                border-radius: 12px;
                overflow: hidden;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                margin: 2rem 0;
            }
            .data-table table {
                width: 100%;
                margin: 0;
            }
            .data-table th {
                background: #f8f9fa;
                color: #495057;
                font-weight: 600;
                padding: 1rem;
                text-align: left;
            }
            .data-table td {
                padding: 1rem;
                border-bottom: 1px solid #e9ecef;
            }
            .data-table tr:last-child td {
                border-bottom: none;
            }

            /* DataTables 2.x styling customizations */
            .dt-container .dt-length,
            .dt-container .dt-search,
            .dt-container .dt-info,
            .dt-container .dt-paging {
                margin-bottom: 1rem;
            }

            /* Hide the default length selector */
            .dt-container .dt-length {
                display: none;
            }

            /* Custom connections filter slider in header */
            .dt-container .dt-search {
                display: flex;
                align-items: center;
                gap: 2rem;
                flex-wrap: wrap;
            }

            .connections-filter-header {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                min-width: 300px;
            }

            .connections-filter-header label {
                font-weight: 600;
                color: #495057;
                white-space: nowrap;
                font-size: 0.875rem;
            }

            .slider-container-header {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                flex: 1;
            }

            .percentage-slider-header {
                flex: 1;
                min-width: 120px;
                -webkit-appearance: none;
                appearance: none;
                height: 6px;
                border-radius: 3px;
                background: #dee2e6;
                outline: none;
            }

            .percentage-slider-header::-webkit-slider-thumb {
                -webkit-appearance: none;
                appearance: none;
                width: 16px;
                height: 16px;
                border-radius: 50%;
                background: #667eea;
                cursor: pointer;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            }

            .percentage-slider-header::-moz-range-thumb {
                width: 16px;
                height: 16px;
                border-radius: 50%;
                background: #667eea;
                cursor: pointer;
                border: none;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            }

            .slider-value-header {
                font-weight: bold;
                color: #667eea;
                min-width: 40px;
                text-align: center;
                font-size: 0.875rem;
            }

            .dt-container .dt-paging .dt-paging-button {
                padding: 0.25rem 0.5rem;
                margin: 0 0.1rem;
                border: 1px solid #dee2e6;
                border-radius: 0.25rem;
                background: white;
            }

            .dt-container .dt-paging .dt-paging-button:hover {
                background: #e9ecef;
                border-color: #adb5bd;
            }

            .dt-container .dt-paging .dt-paging-button.current {
                background: #667eea;
                color: white;
                border-color: #667eea;
            }

            .dt-container .dt-search input {
                border: 1px solid #ced4da;
                border-radius: 0.25rem;
                padding: 0.375rem 0.75rem;
                margin-left: 0.5rem;
            }

            table.dataTable thead th {
                border-bottom: 2px solid #dee2e6;
                position: relative;
            }

            table.dataTable tbody tr:hover {
                background-color: rgba(102, 126, 234, 0.1);
            }

            .cumulative-percent {
                font-weight: bold;
                color: #28a745;
            }
            .sidebar {
                background: #f8f9fa;
                padding: 2rem;
                border-radius: 12px;
                border: 1px solid #e5e7eb;
            }
            .sidebar h3 {
                color: #495057;
                margin-bottom: 1.5rem;
            }
            footer {
                background: #343a40;
                color: white;
                padding: 2rem 0;
                text-align: center;
                margin-top: 3rem;
            }
            body {
                background: #f8f9fa;
            }
            section {
                margin-bottom: 3rem;
            }
            section h2 {
                color: #495057;
                margin-bottom: 1.5rem;
            }

            /* Details/summary styling for column data */
            details {
                margin: 1rem 0;
                border: 1px solid #ddd;
                border-radius: 8px;
                padding: 0;
                background: white;
            }

            details summary {
                padding: 1rem;
                background: #f8f9fa;
                border-radius: 8px 8px 0 0;
                user-select: none;
            }

            details[open] summary {
                border-radius: 8px 8px 0 0;
                border-bottom: 1px solid #ddd;
            }

            details .data-table {
                margin: 0;
                border-radius: 0 0 8px 8px;
                box-shadow: none;
            }

            /* Fast SVG tooltip styles for inline SVG (--embed mode) */
            .svg-tooltip {
                position: absolute;
                background: rgba(0, 0, 0, 0.9);
                color: white;
                padding: 8px 12px;
                border-radius: 4px;
                font-size: 12px;
                font-family: monospace;
                white-space: pre-line;
                z-index: 10000;
                pointer-events: none;
                display: none;
                max-width: 300px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
                line-height: 1.4;
            }
        </style>
    </head>
    <body>
        <div class="neuron-header">
            <div class="container">
                <h1>{{- neuron_type -}}</h1>
                <p>{{- soma_side|title -}} hemisphere analysis</p>
                <p>
                    Generated on {{- generation_time.strftime('%Y-%m-%d %H:%M')
                    -}}
                </p>
            </div>
        </div>

        <div class="container">
            <!-- Summary statistics - Full width -->
            <section>
                <h2>Summary Statistics</h2>
                <div class="row">
                    <div class="col-xs-12 col-sm-6 col-md-3">
                        <div class="stat-card">
                            <div class="stat-number">
                                {{- summary.total_count -}}
                            </div>
                            <div>Total Neurons</div>
                        </div>
                    </div>
                    <div class="col-xs-12 col-sm-6 col-md-3">
                        <div class="stat-card">
                            <div class="stat-number">
                                {{- summary.left_count -}}
                            </div>
                            <div>Left Side</div>
                        </div>
                    </div>
                    <div class="col-xs-12 col-sm-6 col-md-3">
                        <div class="stat-card">
                            <div class="stat-number">
                                {{- summary.right_count -}}
                            </div>
                            <div>Right Side</div>
                        </div>
                    </div>
                    <div class="col-xs-12 col-sm-6 col-md-3">
                        <div class="stat-card">
                            <div class="stat-number">
                                {{- summary.total_pre_synapses|format_number -}}
                            </div>
                            <div>Pre-synapses</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Analysis Details - Cards -->
            <section>
                <h2>Analysis Details</h2>
                <div class="row">
                    <div class="col-xs-12 col-sm-6 col-md-3">
                        <div class="stat-card">
                            <div class="stat-number">
                                {{- soma_side|title -}}
                            </div>
                            <div>Soma Side</div>
                        </div>
                    </div>
                    {%- if summary.avg_pre_synapses > 0 -%}
                    <div class="col-xs-12 col-sm-6 col-md-3">
                        <div class="stat-card">
                            <div class="stat-number">
                                {{- summary.avg_pre_synapses -}}
                            </div>
                            <div>Avg Pre-synapses</div>
                        </div>
                    </div>
                    {%- endif -%}{%- if summary.avg_post_synapses > 0 -%}
                    <div class="col-xs-12 col-sm-6 col-md-3">
                        <div class="stat-card">
                            <div class="stat-number">
                                {{- summary.avg_post_synapses -}}
                            </div>
                            <div>Avg Post-synapses</div>
                        </div>
                    </div>
                    {%- endif -%}
                </div>
            </section>

            <!-- Neuroglancer Visualization -->
            <section>
                <h2>Neuroglancer Visualization</h2>
                <div class="data-table">
                    <iframe
                        src="{{ neuroglancer_url }}"
                        width="100%"
                        height="600"
                        frameborder="0"
                        style="border: 1px solid #e5e7eb; border-radius: 8px"
                    >
                        <p>
                            Your browser does not support iframes.
                            <a href="{{ neuroglancer_url }}" target="_blank"
                                >Open Neuroglancer in new window</a
                            >
                        </p>
                    </iframe>
                </div>
            </section>

            <!-- ROI Innervation - Full width -->
            {%- if roi_summary and roi_summary|length > 0 -%}
            <section>
                <h2>ROI Innervation ({{- roi_summary|length }} ROIs)</h2>
                <div class="data-table">
                    <table id="roi-table" class="display">
                        <thead>
                            <tr>
                                <th>ROI Name</th>
                                <th style="text-align: right">Input</th>
                                <th style="text-align: right">% Input</th>
                                <th style="text-align: right">
                                    Cumulative % Input
                                </th>
                                <th style="text-align: right">Output</th>
                                <th style="text-align: right">% Output</th>
                                <th style="text-align: right">
                                    Cumulative % Output
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {%- for roi in roi_summary -%}
                            <tr>
                                <td><strong>{{- roi.name -}}</strong></td>
                                <td style="text-align: right">
                                    {{- roi.post|format_number -}}
                                </td>
                                <td
                                    style="text-align: right"
                                    title="{{- roi.post_percentage -}}%"
                                >
                                    {{- roi.post_percentage|format_percentage
                                    -}}
                                </td>
                                <td
                                    class="cumulative-percent"
                                    style="text-align: right"
                                >
                                    0
                                </td>
                                <td style="text-align: right">
                                    {{- roi.pre|format_number -}}
                                </td>
                                <td
                                    style="text-align: right"
                                    title="{{- roi.pre_percentage -}}%"
                                >
                                    {{- roi.pre_percentage|format_percentage -}}
                                </td>
                                <td
                                    class="cumulative-percent"
                                    style="text-align: right"
                                >
                                    0
                                </td>
                            </tr>
                            {%- endfor -%}
                        </tbody>
                    </table>
                </div>
            </section>
            {%- endif -%}

            <!-- Column Analysis Table -->
            {%- if column_analysis and column_analysis.columns and
            column_analysis.columns|length > 0 -%}
            <section>
                <h2>
                    Column-Based ROI Analysis ({{-
                    column_analysis.columns|length }} Columns)
                </h2>
                <p>
                    Analysis of neurons with synapses in column-structured ROIs
                    matching pattern: (ME|LO|LOP)_[RL]_col_HEX1_HEX2
                </p>

                <!-- Summary Statistics -->
                <div class="row">
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-number">
                                {{- column_analysis.summary.total_columns -}}
                            </div>
                            <div class="stat-label">Total Columns</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-number">
                                {{-
                                column_analysis.summary.total_neurons_with_columns
                                -}}
                            </div>
                            <div class="stat-label">Neurons with Columns</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-number">
                                {{-
                                column_analysis.summary.avg_neurons_per_column
                                -}}
                            </div>
                            <div class="stat-label">Avg Neurons/Column</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-number">
                                {{-
                                column_analysis.summary.avg_synapses_per_column
                                -}}
                            </div>
                            <div class="stat-label">Avg Synapses/Column</div>
                        </div>
                    </div>
                </div>

                <!-- Region-Specific Hexagonal Grids -->
                {%- if column_analysis.region_grids -%}
                <h3 style="margin-top: 2rem; text-align: center">
                    Region-Specific Analysis
                </h3>

                <!-- Synapse Density Row -->
                <div style="margin-bottom: 3rem">
                    <div
                        style="
                            display: flex;
                            gap: 30px;
                            justify-content: center;
                            flex-wrap: wrap;
                        "
                    >
                        {%- for region, grids in
                        column_analysis.region_grids.items() -%}
                        <div
                            style="
                                text-align: center;
                                background: #f8f9fa;
                                flex: 1;
                                min-width: 300px;
                                max-width: 400px;
                            "
                        >
                            {%- if grids.synapse_density -%} {%- if
                            grids.synapse_density | is_png_data -%}
                            <img
                                src="{{ grids.synapse_density }}"
                                alt="Synapse Density Grid for {{ region }}"
                                style="max-width: 100%; height: auto"
                            />
                            {%- elif grids.synapse_density.endswith('.png') -%}
                            <img
                                src="{{ grids.synapse_density }}"
                                alt="Synapse Density Grid for {{ region }}"
                                style="max-width: 100%; height: auto"
                            />
                            {%- elif grids.synapse_density.endswith('.svg') -%}
                            <object
                                data="{{ grids.synapse_density }}"
                                type="image/svg+xml"
                                style="max-width: 100%; height: auto"
                            >
                                <img
                                    src="{{ grids.synapse_density }}"
                                    alt="Synapse Density Grid for {{ region }}"
                                />
                            </object>
                            {%- else -%} {{ grids.synapse_density | safe }} {%-
                            endif -%} {%- else -%}
                            <p style="color: #999">
                                No synapse density data available
                            </p>
                            {%- endif -%}
                        </div>
                        {%- endfor -%}
                    </div>
                </div>

                <!-- Cell Count Row -->
                <div style="margin-bottom: 3rem">
                    <div
                        style="
                            display: flex;
                            gap: 30px;
                            justify-content: center;
                            flex-wrap: wrap;
                        "
                    >
                        {%- for region, grids in
                        column_analysis.region_grids.items() -%}
                        <div
                            style="
                                text-align: center;
                                flex: 1;
                                min-width: 300px;
                                max-width: 400px;
                            "
                        >
                            {%- if grids.cell_count -%} {%- if grids.cell_count
                            | is_png_data -%}
                            <img
                                src="{{ grids.cell_count }}"
                                alt="Cell Count Grid for {{ region }}"
                                style="max-width: 100%; height: auto"
                            />
                            {%- elif grids.cell_count.endswith('.png') -%}
                            <img
                                src="{{ grids.cell_count }}"
                                alt="Cell Count Grid for {{ region }}"
                                style="max-width: 100%; height: auto"
                            />
                            {%- elif grids.cell_count.endswith('.svg') -%}
                            <object
                                data="{{ grids.cell_count }}"
                                type="image/svg+xml"
                                style="max-width: 100%; height: auto"
                            >
                                <img
                                    src="{{ grids.cell_count }}"
                                    alt="Cell Count Grid for {{ region }}"
                                />
                            </object>
                            {%- else -%} {{ grids.cell_count | safe }} {%- endif
                            -%} {%- else -%}
                            <p style="color: #999">
                                No cell count data available
                            </p>
                            {%- endif -%}
                        </div>
                        {%- endfor -%}
                    </div>
                </div>
                {%- endif -%}
            </section>
            {%- endif -%} {#
            <!-- Neuron details - Full width -->
            {%- if neurons_df is not none and not neurons_df.empty -%}
            <section>
                <h2>Neuron Details</h2>
                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Body ID</th>
                                <th>Instance</th>
                                <th>Pre</th>
                                <th>Post</th>
                                {%- if 'somaSide' in neurons_df.columns -%}
                                <th>Soma Side</th>
                                {%- endif -%}
                            </tr>
                        </thead>
                        <tbody>
                            {%- for _, neuron in neurons_df.iterrows() -%}
                            <tr>
                                <td>
                                    <code
                                        >{{- neuron.get('bodyId', neuron.name)
                                        -}}</code
                                    >
                                </td>
                                <td>{{- neuron.get('type', 'N/A') -}}</td>
                                <td>{{- neuron.get('pre', 0) -}}</td>
                                <td>{{- neuron.get('post', 0) -}}</td>
                                {%- if 'somaSide' in neurons_df.columns -%}
                                <td>{{- neuron.get('somaSide', 'U') -}}</td>
                                {%- endif -%}
                            </tr>
                            {%- endfor -%}
                        </tbody>
                    </table>
                </div>
            </section>
            {%- endif -%} #}

            <!-- Connections - Side by side layout -->
            {%- if connectivity and (connectivity.upstream or
            connectivity.downstream) -%}
            <section>
                <h2>Connectivity Analysis</h2>
                <div class="row">
                    <!-- Upstream Connections -->
                    {%- if connectivity.upstream -%}
                    <div>
                        <h3>Upstream Connections</h3>
                        <p>
                            Neuron types that provide input to {{-
                            neuron_data.type -}}
                        </p>

                        <div class="data-table">
                            <table id="upstream-table" class="display">
                                <thead>
                                    <tr>
                                        <th><span>instance</span></th>
                                        <th>
                                            <span
                                                ><abbr title="neurotransmitter"
                                                    >NT</abbr
                                                ></span
                                            >
                                        </th>
                                        <th><span>total connections</span></th>
                                        <th>
                                            <span
                                                >connections per {{-
                                                neuron_data.type -}}</span
                                            >
                                        </th>
                                        <th><span>% of Input</span></th>
                                        <th><span>Cumulative %</span></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {%- for partner in connectivity.upstream -%}
                                    <tr>
                                        <td>
                                            <strong
                                                >{{- partner.get('type',
                                                'Unknown') -}}
                                                ({{-partner.get('soma_side')
                                                -}})</strong
                                            >
                                        </td>
                                        <td>
                                            {{- partner.get('neurotransmitter',
                                            'Unknown') |
                                            abbreviate_neurotransmitter | safe
                                            -}}
                                        </td>
                                        <td>
                                            {{- partner.get('weight', 0) -}}
                                        </td>
                                        <td>
                                            {{-
                                            partner.get('connections_per_neuron',
                                            0) -}}
                                        </td>
                                        <td>
                                            {{- partner.get('percentage',
                                            0)|format_percentage -}}
                                        </td>
                                        <td class="cumulative-percent">0</td>
                                    </tr>
                                    {%- endfor -%}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {%- endif -%}

                    <!-- Downstream Connections -->
                    {%- if connectivity.downstream -%}
                    <div>
                        <h3>Downstream Connections</h3>
                        <p>
                            Neuron types that receive output from {{-
                            neuron_data.type -}}
                        </p>

                        <div class="data-table">
                            <table id="downstream-table" class="display">
                                <thead>
                                    <tr>
                                        <th><span>instance</span></th>
                                        <th>
                                            <span
                                                ><abbr title="neurotransmitter"
                                                    >NT</abbr
                                                ></span
                                            >
                                        </th>
                                        <th><span>total connections</span></th>
                                        <th>
                                            <span
                                                >connections per {{
                                                neuron_data.type -}}</span
                                            >
                                        </th>
                                        <th><span>% of Output</span></th>
                                        <th><span>Cumulative %</span></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {%- for partner in connectivity.downstream
                                    -%}
                                    <tr>
                                        <td>
                                            <strong
                                                >{{- partner.get('type',
                                                'Unknown') -}}</strong
                                            >
                                        </td>
                                        <td>
                                            {{- partner.get('neurotransmitter',
                                            'Unknown') |
                                            abbreviate_neurotransmitter | safe
                                            -}}
                                        </td>
                                        <td>
                                            {{- partner.get('weight', 0) -}}
                                        </td>
                                        <td>
                                            {{-
                                            partner.get('connections_per_neuron',
                                            0) -}}
                                        </td>
                                        <td>
                                            {{- partner.get('percentage',
                                            0)|format_percentage -}}
                                        </td>
                                        <td class="cumulative-percent">0</td>
                                    </tr>
                                    {%- endfor -%}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {%- endif -%}
                </div>
            </section>
            {%- endif -%}
        </div>

        <footer>
            <div class="container">
                <p>
                    Generated by QuickPage • Dataset: {{-
                    config.neuprint.dataset -}} • Server: {{-
                    config.neuprint.server -}}
                </p>
            </div>
        </footer>

        <!-- jQuery and DataTables Scripts -->
        <script src="static/js/jquery-3.7.1.min.js"></script>
        <script src="static/js/jquery.dataTables.min.js"></script>

        <script>
            $(document).ready(function() {
                // Create lookup map for precise percentage values
                var roiPreciseData = {};
                {% for roi in roi_summary %}
                roiPreciseData['{{- roi.name -}}'] = {
                    inputPrecise: {{- roi.post_percentage -}},
                    outputPrecise: {{- roi.pre_percentage -}}
                };
                {% endfor %}

                // Create lookup map for precise upstream connection percentages
                var upstreamPreciseData = {};
                {% if connectivity.upstream %}
                {% for partner in connectivity.upstream %}
                upstreamPreciseData['{{- partner.get("type", "Unknown") -}} ({{- partner.get("soma_side", "") -}})'] = {{- partner.get("percentage", 0) -}};
                {% endfor %}
                {% endif %}

                // Create lookup map for precise downstream connection percentages
                var downstreamPreciseData = {};
                {% if connectivity.downstream %}
                {% for partner in connectivity.downstream %}
                downstreamPreciseData['{{- partner.get("type", "Unknown") -}} ({{- partner.get("soma_side", "") -}})'] = {{- partner.get("percentage", 0) -}};
                {% endfor %}
                {% endif %}

                // Simple cumulative percentage calculation using precise data
                function calculateCumulativePercentages(table, percentageCol, cumulativeCol) {
                    var cumulativeSum = 0;

                    // Get all rows in current display order
                    table.rows({order: 'current', search: 'applied'}).every(function(rowIdx) {
                        var data = this.data();
                        var roiName = data[0].replace(/<[^>]*>/g, ''); // Remove HTML tags from ROI name

                        var preciseValue = 0;
                        if (roiPreciseData[roiName]) {
                            if (percentageCol === 2) { // % Input column
                                preciseValue = roiPreciseData[roiName].inputPrecise;
                            } else if (percentageCol === 5) { // % Output column
                                preciseValue = roiPreciseData[roiName].outputPrecise;
                            }
                        } else if (upstreamPreciseData[roiName] !== undefined && percentageCol === 4) {
                            // Upstream connection percentages
                            preciseValue = upstreamPreciseData[roiName];
                        } else if (downstreamPreciseData[roiName] !== undefined && percentageCol === 4) {
                            // Downstream connection percentages
                            preciseValue = downstreamPreciseData[roiName];
                        }

                        cumulativeSum += preciseValue;

                        // Update the cumulative column cell
                        this.cell(rowIdx, cumulativeCol).data(cumulativeSum.toFixed(1) + '%');
                    });
                }

                // Custom search function for connections per neuron filtering
                function createConnectionsFilter(tableId, connectionsColumnIndex) {
                    return function(settings, data, dataIndex) {
                        // Only apply this filter to the specific table it was created for
                        if (settings.sTableId !== tableId) return true;

                        var sliderId = settings.sTableId.replace('-table', '-connections-slider');
                        var slider = document.getElementById(sliderId);
                        if (!slider) return true;

                        // Convert slider value from logarithmic scale to actual threshold
                        var sliderValue = parseFloat(slider.value);
                        if (sliderValue == parseFloat(slider.min)){
                          return true;
                        }
                        var minConnections = Math.pow(10, sliderValue);
                        var rowConnections = parseFloat(data[connectionsColumnIndex]) || 0;

                        return rowConnections >= minConnections;
                    };
                }

                // Create and insert slider into DataTables header
                function createConnectionsSliderInHeader(tableId, neuronType) {
                    var sliderId = tableId.replace('-table', '-connections-slider');
                    var valueId = tableId.replace('-table', '-slider-value');

                    // Create the slider HTML
                    var sliderHtml = `
                        <div class="connections-filter-header">
                            <label for="${sliderId}">Min connections:</label>
                            <div class="slider-container-header">
                                <input type="range" id="${sliderId}" class="percentage-slider-header"
                                       min="-1" max="3" value="0" step="0.1">
                                <span class="slider-value-header" id="${valueId}">1.0</span>
                            </div>
                        </div>
                    `;

                    // Insert into the search container
                    var searchContainer = $('#' + tableId + '_wrapper .dt-search');
                    if (searchContainer.length) {
                        searchContainer.append(sliderHtml);
                    }
                }

                // Setup slider functionality with logarithmic scale
                function setupConnectionsSlider(sliderId, valueId, table) {
                    var slider = document.getElementById(sliderId);
                    var valueDisplay = document.getElementById(valueId);

                    if (slider && valueDisplay) {
                        // Initialize slider at position representing 1.0 connection (log10(1) = 0)
                        slider.value = Math.log10(1); // This equals 0

                        // Set initial display value
                        var initialValue = Math.pow(10, parseFloat(slider.value));
                        valueDisplay.textContent = initialValue.toFixed(1);

                        slider.addEventListener('input', function() {
                            // Convert from logarithmic scale to actual value
                            var actualValue = Math.pow(10, parseFloat(this.value));
                            valueDisplay.textContent = actualValue.toFixed(1);
                            table.draw();
                        });

                        // Trigger initial filter application
                        table.draw();
                    }
                }

                // Initialize upstream table
                {% if connectivity.upstream %}
                // Add custom search for upstream table only
                $.fn.dataTable.ext.search.push(createConnectionsFilter('upstream-table', 3));

                var upstreamTable = $('#upstream-table').DataTable({
                    "order": [[ 3, "desc" ]], // Sort by percentage column (descending)
                    "pageLength": -1, // Show all rows
                    "paging": false, // Disable pagination since we're using connections filter
                    "responsive": true,
                    "columnDefs": [
                        {
                            "targets": 4, // % of Input column
                            "type": "num-fmt",
                            "render": function(data, type, row) {
                                if (type === 'display') {
                                    return data;
                                }
                                return parseFloat(data.replace('%', '')) || 0;
                            }
                        }
                    ],
                    "drawCallback": function(settings) {
                        calculateCumulativePercentages(this.api(), 4, 5);
                    },
                    "initComplete": function(settings, json) {
                        // Create slider in header after table initialization
                        createConnectionsSliderInHeader('upstream-table', '{{- neuron_data.type -}}');
                        setupConnectionsSlider('upstream-connections-slider', 'upstream-slider-value', this.api());
                    }
                });
                {% endif %}

                // Initialize downstream table
                {% if connectivity.downstream %}
                // Add custom search for downstream table only
                $.fn.dataTable.ext.search.push(createConnectionsFilter('downstream-table', 3));

                var downstreamTable = $('#downstream-table').DataTable({
                    "order": [[ 3, "desc" ]], // Sort by percentage column (descending)
                    "pageLength": -1, // Show all rows
                    "paging": false, // Disable pagination since we're using connections filter
                    "responsive": true,
                    "columnDefs": [
                        {
                            "targets": 4, // % of Output column
                            "type": "num-fmt",
                            "render": function(data, type, row) {
                                if (type === 'display') {
                                    return data;
                                }
                                return parseFloat(data.replace('%', '')) || 0;
                            }
                        }
                    ],
                    "drawCallback": function(settings) {
                        calculateCumulativePercentages(this.api(), 4, 5);
                    },
                    "initComplete": function(settings, json) {
                        // Create slider in header after table initialization
                        createConnectionsSliderInHeader('downstream-table', '{{- neuron_data.type -}}');
                        setupConnectionsSlider('downstream-connections-slider', 'downstream-slider-value', this.api());
                    }
                });
                {% endif %}

                // Initialize ROI table with DataTables
                {% if roi_summary and roi_summary|length > 0 %}
                // Custom search function for ROI percentage filtering
                function createROIPercentageFilter(tableId) {
                    return function(settings, data, dataIndex) {
                        // Only apply this filter to the specific table it was created for
                        if (settings.sTableId !== tableId) return true;

                        var sliderId = settings.sTableId.replace('-table', '-percentage-slider');
                        var slider = document.getElementById(sliderId);
                        if (!slider) return true;

                        if (parseFloat(slider.value) == parseFloat(slider.min)){
                          return true;
                        }
                        // Convert from logarithmic scale to actual percentage threshold
                        var minPercentage = Math.pow(10, parseFloat(slider.value));
                        var inputPercentage = parseFloat(data[2]) || 0;  // % Input column
                        var outputPercentage = parseFloat(data[5]) || 0; // % Output column

                        // Show row if EITHER input OR output percentage meets threshold
                        return inputPercentage >= minPercentage || outputPercentage >= minPercentage;
                    };
                }

                // Create and insert percentage slider into DataTables header
                function createROIPercentageSliderInHeader(tableId) {
                    var sliderId = tableId.replace('-table', '-percentage-slider');
                    var valueId = tableId.replace('-table', '-slider-value');

                    // Create the slider HTML
                    var sliderHtml = `
                        <div class="connections-filter-header">
                            <label for="${sliderId}">Min % Input:</label>
                            <div class="slider-container-header">
                                <input type="range" id="${sliderId}" class="percentage-slider-header"
                                       min="-1.4" max="2" value="0.176" step="0.01">
                                <span class="slider-value-header" id="${valueId}">1.5%</span>
                            </div>
                        </div>
                    `;

                    // Insert into the search container
                    var searchContainer = $('#' + tableId + '_wrapper .dt-search');
                    if (searchContainer.length) {
                        searchContainer.append(sliderHtml);
                    }
                }

                // Setup ROI percentage slider functionality
                function setupROIPercentageSlider(sliderId, valueId, table) {
                    var slider = document.getElementById(sliderId);
                    var valueDisplay = document.getElementById(valueId);

                    if (slider && valueDisplay) {
                        // Initialize slider at 1.5% (log10(1.5) ≈ 0.176)
                        slider.value = Math.log10(1.5);
                        var initialValue = Math.pow(10, parseFloat(slider.value));
                        valueDisplay.textContent = initialValue.toFixed(1) + '%';

                        slider.addEventListener('input', function() {
                            // Convert from logarithmic scale to actual percentage
                            var actualValue = Math.pow(10, parseFloat(this.value));
                            valueDisplay.textContent = actualValue.toFixed(1) + '%';
                            table.draw();
                        });

                        // Trigger initial filter application
                        table.draw();
                    }
                }

                // Add custom search for ROI table
                $.fn.dataTable.ext.search.push(createROIPercentageFilter('roi-table'));

                var roiTable = $('#roi-table').DataTable({
                    "order": [[ 2, "desc" ]], // Sort by % Input column (descending)
                    "pageLength": -1, // Show all rows
                    "paging": false, // Disable pagination since we're using percentage filter
                    "responsive": true,
                    "columnDefs": [
                        {
                            "targets": [2, 5], // % Input and % Output columns
                            "type": "num-fmt",
                            "render": function(data, type, row, meta) {
                                if (type === 'display') {
                                    return data;
                                }
                                return parseFloat(data.replace('%', '')) || 0;
                            }
                        },
                        {
                            "targets": [1, 4], // Input and Output columns
                            "className": "dt-right"
                        }
                    ],
                    "drawCallback": function(settings) {
                        // Calculate cumulative percentages for both input and output
                        calculateCumulativePercentages(this.api(), 2, 3); // % Input -> Cumulative % Input
                        calculateCumulativePercentages(this.api(), 5, 6); // % Output -> Cumulative % Output
                    },
                    "initComplete": function(settings, json) {
                        // Create slider in header after table initialization
                        createROIPercentageSliderInHeader('roi-table');
                        setupROIPercentageSlider('roi-percentage-slider', 'roi-slider-value', this.api());
                    }
                });

                console.log('ROI table loaded with', {{- roi_summary|length -}}, 'primary ROIs');
                {% endif %}

                // Initialize Column table with DataTables (simplified)
                {% if column_analysis and column_analysis.columns and column_analysis.columns|length > 0 %}
                var columnTable = $('#column-table').DataTable({
                    "order": [[ 0, "asc" ], [ 1, "asc" ], [ 2, "asc" ], [ 3, "asc" ]],  // Sort by region, side, row, col
                    "pageLength": 25,
                    "responsive": true,
                    "columnDefs": [
                        {"className": "dt-right", "targets": [4, 5]},  // Right-align numeric columns
                        {"type": "num", "targets": [4, 5]}  // Treat as numbers for sorting
                    ],
                    "language": {
                        "search": "Search columns:",
                        "lengthMenu": "Show _MENU_ columns per page",
                        "info": "Showing _START_ to _END_ of _TOTAL_ columns",
                        "infoEmpty": "No columns available",
                        "infoFiltered": "(filtered from _MAX_ total columns)"
                    }
                });
                console.log('Column table loaded with', {{- column_analysis.columns|length -}}, 'columns');
                {% endif %}



                // Fast tooltip support for inline SVGs (--embed mode)
                function initializeInlineSVGTooltips() {
                    // Create tooltip element for inline SVGs
                    const tooltip = document.createElement('div');
                    tooltip.className = 'svg-tooltip inline-svg-tooltip';
                    document.body.appendChild(tooltip);

                    // Find all inline SVG elements with paths that have titles
                    const inlineSVGs = document.querySelectorAll('svg');

                    inlineSVGs.forEach(svg => {
                        const paths = svg.querySelectorAll('path[fill] title');

                        paths.forEach(titleElement => {
                            const path = titleElement.parentNode;
                            const tooltipText = titleElement.textContent;

                            if (tooltipText.trim()) {
                                path.addEventListener('mouseenter', function(e) {
                                    // Hide native title immediately
                                    titleElement.textContent = '';

                                    // Show custom tooltip
                                    tooltip.textContent = tooltipText;
                                    tooltip.style.display = 'block';

                                    // Position tooltip near mouse
                                    const updateTooltipPosition = (event) => {
                                        const x = event.clientX + window.scrollX;
                                        const y = event.clientY + window.scrollY;
                                        tooltip.style.left = (x + 10) + 'px';
                                        tooltip.style.top = (y - 10) + 'px';
                                    };

                                    updateTooltipPosition(e);

                                    // Follow mouse movement
                                    const mouseMoveHandler = updateTooltipPosition;
                                    document.addEventListener('mousemove', mouseMoveHandler);

                                    // Store cleanup function
                                    path._inlineTooltipCleanup = () => {
                                        document.removeEventListener('mousemove', mouseMoveHandler);
                                    };
                                });

                                path.addEventListener('mouseleave', function() {
                                    // Restore native title
                                    titleElement.textContent = tooltipText;

                                    // Hide custom tooltip
                                    tooltip.style.display = 'none';

                                    // Clean up mouse move listener
                                    if (path._inlineTooltipCleanup) {
                                        path._inlineTooltipCleanup();
                                        delete path._inlineTooltipCleanup;
                                    }
                                });
                            }
                        });
                    });
                }

                // Initialize inline SVG tooltips with slight delay to ensure DOM is ready
                setTimeout(initializeInlineSVGTooltips, 100);
            });
        </script>
    </body>
</html>
