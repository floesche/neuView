<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>{{ config.html.title_prefix }} - {{ neuron_data.type }}</title>
        <link rel="stylesheet" href="static/css/plume-all.css" />
        <link rel="stylesheet" href="static/css/plume-theme-default.css" />
        <link rel="stylesheet" href="static/css/flexboxgrid.min.css" />
        <!-- DataTables CSS -->
        <link rel="stylesheet" href="static/css/dataTables.dataTables.min.css" />
        <link rel="stylesheet" href="static/css/dataTables.bootstrap4.min.css" />
        <!-- Custom Neuron Page CSS -->
        <link rel="stylesheet" href="static/css/neuron-page.css" />
    </head>
    <body class="plume">
        <div class="neuron-header">
            <div class="container">
                <h1>{{- neuron_type }} {{ '(' ~ soma_side[0]|upper ~ ')' if soma_side!='' else '' -}}
                    , n= {{- summary.total_count }} cell{{- 's' if summary.total_count > 1 else '' }}</h1>
            </div>
        </div>

        <div class="container">
            <!-- Summary statistics - Full width -->
            <section>
                <h2>Summary Statistics</h2>
                <div class="row">
                    <div class="col-xs-12 col-sm-6 col-md-3">
                        <div class="stat-card">
                            <div class="stat-number">{{- summary.total_count -}}</div>
                            <div>Total Neurons</div>
                        </div>
                    </div>
                    <div class="col-xs-12 col-sm-6 col-md-3">
                        <div class="stat-card">
                            <div class="stat-number">{{- summary.left_count -}}</div>
                            <div>Left Side</div>
                        </div>
                    </div>
                    <div class="col-xs-12 col-sm-6 col-md-3">
                        <div class="stat-card">
                            <div class="stat-number">{{- summary.right_count -}}</div>
                            <div>Right Side</div>
                        </div>
                    </div>
                    <div class="col-xs-12 col-sm-6 col-md-3">
                        <div class="stat-card">
                            <div class="stat-number">{{- summary.total_pre_synapses|format_number -}}</div>
                            <div>Pre-synapses</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Analysis Details - Cards -->
            <section>
                <h2>Analysis Details</h2>
                <div class="row">
                    <div class="col-xs-12 col-sm-6 col-md-3">
                        <div class="stat-card">
                            <div class="stat-number">{{- soma_side|title -}}</div>
                            <div>Soma Side</div>
                        </div>
                    </div>
                    {%- if summary.avg_pre_synapses > 0 -%}
                    <div class="col-xs-12 col-sm-6 col-md-3">
                        <div class="stat-card">
                            <div class="stat-number">{{- summary.avg_pre_synapses -}}</div>
                            <div>Avg Pre-synapses</div>
                        </div>
                    </div>
                    {%- endif -%}{%- if summary.avg_post_synapses > 0 -%}
                    <div class="col-xs-12 col-sm-6 col-md-3">
                        <div class="stat-card">
                            <div class="stat-number">{{- summary.avg_post_synapses -}}</div>
                            <div>Avg Post-synapses</div>
                        </div>
                    </div>
                    {%- endif -%}
                </div>
            </section>

            <!-- Neuroglancer Visualization -->
            <section>
                <h2>Neuroglancer Visualization</h2>
                <div>
                    <iframe src="{{ neuroglancer_url }}" width="100%" height="720" frameborder="0">
                        <p>Your browser does not support iframes. <a href="{{ neuroglancer_url }}" target="_blank">Open Neuroglancer in new window</a></p>
                    </iframe>
                </div>
            </section>

            <!-- Layer Analysis Containers -->
            {%- if layer_analysis and layer_analysis.containers and (layer_analysis.containers.la.columns or layer_analysis.containers.me.columns or layer_analysis.containers.lo.columns or layer_analysis.containers.lop.columns or layer_analysis.containers.ame.columns or layer_analysis.containers.central_brain.columns) -%}
            <section id="layer-stats">
                <h2>Mean Synapse Count per Layer</h2>

                <!-- Add legend for row meanings -->
                <div class="legend-text"></div>

                <!-- Row 1: LA + ME Layers -->
                <div class="row layer-row">
                    <div class="col-xs-6 col-md-1">
                        <table class="display layer-table layer-table-white">
                            <thead>
                                <tr>
                                    <th>&nbsp;</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>Post</strong></td>
                                </tr>
                                <tr>
                                    <td><strong>Pre</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <!-- LA Container -->
                    {%- if layer_analysis.containers.la.columns -%}
                    <div class="col-xs-6 col-md-2">
                        <table class="display layer-table layer-table-la">
                            <thead>
                                <tr>
                                    {%- for col in layer_analysis.containers.la.columns -%}
                                    <th class="text-right">{{- col -}}</th>
                                    {%- endfor -%}
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    {%- for col in layer_analysis.containers.la.columns -%}
                                    <td class="text-right">{{- layer_analysis.containers.la.data.post[col]|format_synapse_count|safe -}}</td>
                                    {%- endfor -%}
                                </tr>
                                <tr>
                                    {%- for col in layer_analysis.containers.la.columns -%}
                                    <td class="text-right">{{- layer_analysis.containers.la.data.pre[col]|format_synapse_count|safe -}}</td>
                                    {%- endfor -%}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    {%- endif -%}

                    <!-- ME Layers Container -->
                    {%- if layer_analysis.containers.me.columns -%}
                    <div class="col-xs-12 col-md-9">
                        <table class="display layer-table layer-table-me">
                            <thead>
                                <tr>
                                    {%- for col in layer_analysis.containers.me.columns -%}
                                    <th class="text-right{% if col == "Total" %} total-column{% endif %}">{{- col -}}</th>
                                    {%- endfor -%}
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    {%- for col in layer_analysis.containers.me.columns -%}
                                    <td class="text-right{% if col == "Total" %} total-column{% endif %}">
                                        {{- layer_analysis.containers.me.data.post[col]|format_synapse_count|safe -}}
                                    </td>
                                    {%- endfor -%}
                                </tr>
                                <tr>
                                    {%- for col in layer_analysis.containers.me.columns -%}
                                    <td class="text-right{% if col == "Total" %} total-column{% endif %}">
                                        {{- layer_analysis.containers.me.data.pre[col]|format_synapse_count|safe -}}
                                    </td>
                                    {%- endfor -%}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    {%- endif -%}
                </div>

                <!-- Row 2: LO + AME -->
                <div class="row layer-row">
                    <!-- LO Layers Container -->
                    <div class="col-xs-2 col-md-1">
                        <table class="display layer-table layer-table-white">
                            <thead>
                                <tr>
                                    <th>&nbsp;</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>Post</strong></td>
                                </tr>
                                <tr>
                                    <td><strong>Pre</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    {%- if layer_analysis.containers.lo.columns -%}
                    <div class="col-xs-10 col-md-8">
                        <table class="display layer-table layer-table-lo">
                            <thead>
                                <tr>
                                    {%- for col in layer_analysis.containers.lo.columns -%}
                                    <th class="text-right{% if col == "Total" %} total-column{% endif %}">{{- col -}}</th>
                                    {%- endfor -%}
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    {%- for col in layer_analysis.containers.lo.columns -%}
                                    <td class="text-right{% if col == "Total" %} total-column{% endif %}">
                                        {{- layer_analysis.containers.lo.data.post[col]|format_synapse_count|safe -}}
                                    </td>
                                    {%- endfor -%}
                                </tr>
                                <tr>
                                    {%- for col in layer_analysis.containers.lo.columns -%}
                                    <td class="text-right{% if col == "Total" %} total-column{% endif %}">
                                        {{- layer_analysis.containers.lo.data.pre[col]|format_synapse_count|safe -}}
                                    </td>
                                    {%- endfor -%}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    {%- endif -%}

                    <!-- AME Container -->
                    {%- if layer_analysis.containers.ame.columns -%}
                    <div class="col-xs-12 col-md-3">
                        <table class="display layer-table layer-table-ame">
                            <thead>
                                <tr>
                                    {%- for col in layer_analysis.containers.ame.columns -%}
                                    <th class="text-right">{{- col -}}</th>
                                    {%- endfor -%}
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    {%- for col in layer_analysis.containers.ame.columns -%}
                                    <td class="text-right">{{- layer_analysis.containers.ame.data.post[col]|format_synapse_count|safe -}}</td>
                                    {%- endfor -%}
                                </tr>
                                <tr>
                                    {%- for col in layer_analysis.containers.ame.columns -%}
                                    <td class="text-right">{{- layer_analysis.containers.ame.data.pre[col]|format_synapse_count|safe -}}</td>
                                    {%- endfor -%}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    {%- endif -%}
                </div>

                <!-- Row 3: LOP + Central Brain -->
                <div class="row layer-row">
                    <!-- LOP Layers Container -->

                    <div class="col-xs-2 col-md-1">
                        <table class="display layer-table layer-table-white">
                            <thead>
                                <tr>
                                    <th>&nbsp;</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>Post</strong></td>
                                </tr>
                                <tr>
                                    <td><strong>Pre</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    {%- if layer_analysis.containers.lop.columns -%}
                    <div class="col-xs-10 col-md-8">
                        <table class="display layer-table layer-table-lop">
                            <thead>
                                <tr>
                                    {%- for col in layer_analysis.containers.lop.columns -%}
                                    <th class="text-right{% if col == "Total" %} total-column{% endif %}">{{- col -}}</th>
                                    {%- endfor -%}
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    {%- for col in layer_analysis.containers.lop.columns -%}
                                    <td class="text-right{% if col == "Total" %} total-column{% endif %}">
                                        {{- layer_analysis.containers.lop.data.post[col]|format_synapse_count|safe -}}
                                    </td>
                                    {%- endfor -%}
                                </tr>
                                <tr>
                                    {%- for col in layer_analysis.containers.lop.columns -%}
                                    <td class="text-right{% if col == "Total" %} total-column{% endif %}">
                                        {{- layer_analysis.containers.lop.data.pre[col]|format_synapse_count|safe -}}
                                    </td>
                                    {%- endfor -%}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    {%- endif -%}

                    <!-- Central Brain Container -->
                    {%- if layer_analysis.containers.central_brain.columns -%}
                    <div class="col-xs-12 col-md-3">
                        <table class="display layer-table layer-table-central">
                            <thead>
                                <tr>
                                    {%- for col in layer_analysis.containers.central_brain.columns -%}
                                    <th class="text-right">{{- col -}}</th>
                                    {%- endfor -%}
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    {%- for col in layer_analysis.containers.central_brain.columns -%}
                                    <td class="text-right">{{- layer_analysis.containers.central_brain.data.post[col]|format_synapse_count|safe -}}</td>
                                    {%- endfor -%}
                                </tr>
                                <tr>
                                    {%- for col in layer_analysis.containers.central_brain.columns -%}
                                    <td class="text-right">{{- layer_analysis.containers.central_brain.data.pre[col]|format_synapse_count|safe -}}</td>
                                    {%- endfor -%}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    {%- endif -%}
                </div>
            </section>
            {%- endif -%}

            <!-- ROI Innervation - Full width -->
            {%- if roi_summary and roi_summary|length > 0 -%}
            <section>
                <h2>ROI Innervation ({{- roi_summary|length }} ROIs)</h2>
                <div class="data-table">
                    <table id="roi-table" class="display">
                        <thead>
                            <tr>
                                <th>ROI Name</th>
                                <th class="roi-table-header">Input</th>
                                <th class="roi-table-header">% Input</th>
                                <th class="roi-table-header">
                                    Cumulative % Input
                                </th>
                                <th class="roi-table-header">Output</th>
                                <th class="roi-table-header">% Output</th>
                                <th class="roi-table-header">
                                    Cumulative % Output
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {%- for roi in roi_summary -%}
                            <tr>
                                <td><strong>{{- roi.name -}}</strong></td>
                                <td class="roi-table-cell">{{- roi.post|format_number -}}</td>
                                <td class="roi-table-cell" title="{{- roi.post_percentage -}}%">{{- roi.post_percentage|format_percentage -}}</td>
                                <td class="cumulative-percent roi-table-cell">0</td>
                                <td class="roi-table-cell">{{- roi.pre|format_number -}}</td>
                                <td class="roi-table-cell" title="{{- roi.pre_percentage -}}%">{{- roi.pre_percentage|format_percentage -}}</td>
                                <td class="cumulative-percent roi-table-cell">0</td>
                            </tr>
                            {%- endfor -%}
                        </tbody>
                    </table>
                </div>
            </section>
            {%- endif -%}

            <!-- Column Analysis Table -->
            {%- if column_analysis and column_analysis.columns and column_analysis.columns|length > 0 -%}
            <section>
                <h2>Column-Based ROI Analysis ({{- column_analysis.columns|length }} Columns)</h2>
                <p>
                    Analysis of neurons with synapses in column-structured ROIs
                    matching pattern: (ME|LO|LOP)_[RL]_col_HEX1_HEX2
                </p>

                <!-- Summary Statistics -->
                <div class="row">
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-number">
                                {{- column_analysis.summary.total_columns -}}
                            </div>
                            <div class="stat-label">Total Columns</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-number">{{- column_analysis.summary.total_neurons_with_columns -}}</div>
                            <div class="stat-label">Neurons with Columns</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-number">{{- column_analysis.summary.avg_neurons_per_column -}}</div>
                            <div class="stat-label">Avg Neurons/Column</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-number">{{- column_analysis.summary.avg_synapses_per_column -}}</div>
                            <div class="stat-label">Avg Synapses/Column</div>
                        </div>
                    </div>
                </div>

                <!-- Region-Specific Hexagonal Grids -->
                {%- if column_analysis.comprehensive_region_grids -%}
                <h3 class="analysis-title">
                    Region-Specific Analysis
                </h3>

                <!-- Synapse Density Row -->
                <div class="region-grid-section">
                    <div class="region-grid-container">
                        {%- for region in ['ME', 'LO', 'LOP'] -%}
                        {%- if column_analysis.comprehensive_region_grids[region] -%}
                        <div class="region-grid-item">
                            {%- if column_analysis.comprehensive_region_grids[region].synapse_density -%}
                            {%- if column_analysis.comprehensive_region_grids[region].synapse_density | is_png_data -%}
                            <img src="{{ column_analysis.comprehensive_region_grids[region].synapse_density }}" alt="Complete Synapse Density Grid for {{ region }}" class="grid-image" />
                            {%- elif column_analysis.comprehensive_region_grids[region].synapse_density.endswith('.png') -%}
                            <img src="{{ column_analysis.comprehensive_region_grids[region].synapse_density }}" alt="Complete Synapse Density Grid for {{ region }}" class="grid-image" />
                            {%- elif column_analysis.comprehensive_region_grids[region].synapse_density.endswith('.svg') -%}
                            <object data="{{ column_analysis.comprehensive_region_grids[region].synapse_density }}" type="image/svg+xml" class="grid-image">
                                <img src="{{ column_analysis.comprehensive_region_grids[region].synapse_density }}" alt="Complete Synapse Density Grid for {{ region }}" />
                            </object>
                            {%- else -%}
                            {{ column_analysis.comprehensive_region_grids[region].synapse_density | safe }}
                            {%- endif -%}
                            {%- else -%}
                            <p class="no-data-text">No comprehensive synapse density data available</p>
                            {%- endif -%}
                        </div>
                        {%- endif -%}
                        {%- endfor -%}
                    </div>
                </div>

                <!-- Cell Count Row -->
                <div class="region-grid-section">
                    <div class="region-grid-container">
                        {%- for region in ['ME', 'LO', 'LOP'] -%}
                        {%- if column_analysis.comprehensive_region_grids[region] -%}
                        <div class="region-grid-item-no-bg">
                            {%- if column_analysis.comprehensive_region_grids[region].synapse_density -%}
                            {%- if column_analysis.comprehensive_region_grids[region].synapse_density | is_png_data -%}
                            <img src="{{ column_analysis.comprehensive_region_grids[region].synapse_density }}" alt="Complete Synapse Density Grid for {{ region }}" class="grid-image" />
                            {%- elif column_analysis.comprehensive_region_grids[region].synapse_density.endswith('.png') -%}
                            <img src="{{ column_analysis.comprehensive_region_grids[region].synapse_density }}" alt="Complete Synapse Density Grid for {{ region }}" class="grid-image" />
                            {%- elif column_analysis.comprehensive_region_grids[region].synapse_density.endswith('.svg') -%}
                            <object data="{{ column_analysis.comprehensive_region_grids[region].synapse_density }}" type="image/svg+xml" class="grid-image">
                                <img src="{{ column_analysis.comprehensive_region_grids[region].synapse_density }}" alt="Complete Synapse Density Grid for {{ region }}" />
                            </object>
                            {%- else -%}
                            {{ column_analysis.comprehensive_region_grids[region].synapse_density | safe }}
                            {%- endif -%}
                            {%- else -%}
                            <p class="no-data-text">No comprehensive synapse density data available</p>
                            {%- endif -%}
                        </div>
                        {%- endif -%}
                        {%- endfor -%}
                    </div>
                </div>
                {%- endif -%}
            </section>
            {%- endif -%} {#
            <!-- Neuron details - Full width -->
            {%- if neurons_df is not none and not neurons_df.empty -%}
            <section>
                <h2>Neuron Details</h2>
                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Body ID</th>
                                <th>Instance</th>
                                <th>Pre</th>
                                <th>Post</th>
                                {%- if 'somaSide' in neurons_df.columns -%}
                                <th>Soma Side</th>
                                {%- endif -%}
                            </tr>
                        </thead>
                        <tbody>
                            {%- for _, neuron in neurons_df.iterrows() -%}
                            <tr>
                                <td>
                                    <code
                                        >{{- neuron.get('bodyId', neuron.name)
                                        -}}</code>
                                </td>
                                <td>{{- neuron.get('type', 'N/A') -}}</td>
                                <td>{{- neuron.get('pre', 0) -}}</td>
                                <td>{{- neuron.get('post', 0) -}}</td>
                                {%- if 'somaSide' in neurons_df.columns -%}
                                <td>{{- neuron.get('somaSide', 'U') -}}</td>
                                {%- endif -%}
                            </tr>
                            {%- endfor -%}
                        </tbody>
                    </table>
                </div>
            </section>
            {%- endif -%} #}

            <!-- Connections - Side by side layout -->
            {%- if connectivity and (connectivity.upstream or connectivity.downstream) -%}
            <section>
                <h2>Connectivity Analysis</h2>
                <div class="row">
                    <!-- Upstream Connections -->
                    {%- if connectivity.upstream -%}
                    <div>
                        <h3>Upstream Connections</h3>
                        <p>Neuron types that provide input to {{- neuron_data.type -}}</p>

                        <div class="data-table">
                            <table id="upstream-table" class="display">
                                <thead>
                                    <tr>
                                        <th><span>instance</span></th>
                                        <th>
                                            <span
                                                ><abbr title="neurotransmitter"
                                                    >NT</abbr
                                                ></span>
                                        </th>
                                        <th><span>total connections</span></th>
                                        <th>
                                            <span>connections per {{- neuron_data.type -}}</span>
                                        </th>
                                        <th><span>% of Input</span></th>
                                        <th><span>Cumulative %</span></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {%- for partner in connectivity.upstream -%}
                                    <tr>
                                        <td><strong>{{- partner.get('type', 'Unknown') -}} ({{-partner.get('soma_side') -}})</strong></td>
                                        <td>{{- partner.get('neurotransmitter', 'Unknown') | abbreviate_neurotransmitter | safe -}}</td>
                                        <td>{{- partner.get('weight', 0) -}}</td>
                                        <td>{{- partner.get('connections_per_neuron', 0) -}}</td>
                                        <td>{{- partner.get('percentage', 0)|format_percentage -}}</td>
                                        <td class="cumulative-percent">0</td>
                                    </tr>
                                    {%- endfor -%}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {%- endif -%}

                    <!-- Downstream Connections -->
                    {%- if connectivity.downstream -%}
                    <div>
                        <h3>Downstream Connections</h3>
                        <p>Neuron types that receive output from {{- neuron_data.type -}}</p>

                        <div class="data-table">
                            <table id="downstream-table" class="display">
                                <thead>
                                    <tr>
                                        <th><span>instance</span></th>
                                        <th>
                                            <span
                                                ><abbr title="neurotransmitter"
                                                    >NT</abbr
                                                ></span>
                                        </th>
                                        <th><span>total connections</span></th>
                                        <th>
                                            <span
                                                >connections per {{
                                                neuron_data.type -}}</span>
                                        </th>
                                        <th><span>% of Output</span></th>
                                        <th><span>Cumulative %</span></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {%- for partner in connectivity.downstream
                                    -%}
                                    <tr>
                                        <td><strong>{{- partner.get('type', 'Unknown') -}}</strong></td>
                                        <td>{{- partner.get('neurotransmitter', 'Unknown') | abbreviate_neurotransmitter | safe -}}</td>
                                        <td>{{- partner.get('weight', 0) -}}</td>
                                        <td>{{- partner.get('connections_per_neuron', 0) -}}</td>
                                        <td>{{- partner.get('percentage', 0)|format_percentage -}}</td>
                                        <td class="cumulative-percent">0</td>
                                    </tr>
                                    {%- endfor -%}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {%- endif -%}
                </div>
            </section>
            {%- endif -%}
        </div>

        <footer>
            <div class="container">
                <p>Generated on {{- generation_time.strftime('%Y-%m-%d %H:%M') -}} • Dataset: {{- config.neuprint.dataset -}} • Server: {{- config.neuprint.server -}}</p>
            </div>
        </footer>

        <!-- jQuery and DataTables Scripts -->
        <script src="static/js/jquery-3.7.1.min.js"></script>
        <script src="static/js/jquery.dataTables.min.js"></script>

        <script>
            $(document).ready(function() {
                // Create lookup map for precise percentage values
                var roiPreciseData = {};
                {% for roi in roi_summary %}
                roiPreciseData['{{- roi.name -}}'] = {
                    inputPrecise: {{- roi.post_percentage -}},
                    outputPrecise: {{- roi.pre_percentage -}}
                };
                {% endfor %}

                // Create lookup map for precise upstream connection percentages
                var upstreamPreciseData = {};
                {% if connectivity.upstream %}{% for partner in connectivity.upstream %}
                upstreamPreciseData['{{- partner.get("type", "Unknown") -}} ({{- partner.get("soma_side", "") -}})'] = {{- partner.get("percentage", 0) -}};
                {% endfor %}{% endif %}

                // Create lookup map for precise downstream connection percentages
                var downstreamPreciseData = {};
                {% if connectivity.downstream %}{% for partner in connectivity.downstream %}
                downstreamPreciseData['{{- partner.get("type", "Unknown") -}} ({{- partner.get("soma_side", "") -}})'] = {{- partner.get("percentage", 0) -}};
                {% endfor %}{% endif %}

                // Simple cumulative percentage calculation using precise data
                function calculateCumulativePercentages(table, percentageCol, cumulativeCol) {
                    var cumulativeSum = 0;

                    // Get all rows in current display order
                    table.rows({order: 'current', search: 'applied'}).every(function(rowIdx) {
                        var data = this.data();
                        var roiName = data[0].replace(/<[^>]*>/g, ''); // Remove HTML tags from ROI name

                        var preciseValue = 0;
                        if (roiPreciseData[roiName]) {
                            if (percentageCol === 2) { // % Input column
                                preciseValue = roiPreciseData[roiName].inputPrecise;
                            } else if (percentageCol === 5) { // % Output column
                                preciseValue = roiPreciseData[roiName].outputPrecise;
                            }
                        } else if (upstreamPreciseData[roiName] !== undefined && percentageCol === 4) {
                            // Upstream connection percentages
                            preciseValue = upstreamPreciseData[roiName];
                        } else if (downstreamPreciseData[roiName] !== undefined && percentageCol === 4) {
                            // Downstream connection percentages
                            preciseValue = downstreamPreciseData[roiName];
                        }

                        cumulativeSum += preciseValue;

                        // Update the cumulative column cell
                        this.cell(rowIdx, cumulativeCol).data(cumulativeSum.toFixed(1) + '%');
                    });
                }

                // Custom search function for connections per neuron filtering
                function createConnectionsFilter(tableId, connectionsColumnIndex) {
                    return function(settings, data, dataIndex) {
                        // Only apply this filter to the specific table it was created for
                        if (settings.sTableId !== tableId) return true;

                        var sliderId = settings.sTableId.replace('-table', '-connections-slider');
                        var slider = document.getElementById(sliderId);
                        if (!slider) return true;

                        // Convert slider value from logarithmic scale to actual threshold
                        var sliderValue = parseFloat(slider.value);
                        if (sliderValue == parseFloat(slider.min)){
                          return true;
                        }
                        var minConnections = Math.pow(10, sliderValue);
                        var rowConnections = parseFloat(data[connectionsColumnIndex]) || 0;

                        return rowConnections >= minConnections;
                    };
                }

                // Create and insert slider into DataTables header
                function createConnectionsSliderInHeader(tableId, neuronType) {
                    var sliderId = tableId.replace('-table', '-connections-slider');
                    var valueId = tableId.replace('-table', '-slider-value');

                    // Create the slider HTML
                    var sliderHtml = `
                        <div class="connections-filter-header">
                            <label for="${sliderId}">Min connections:</label>
                            <div class="slider-container-header">
                                <input type="range" id="${sliderId}" class="percentage-slider-header"
                                       min="-1" max="3" value="0" step="0.1">
                                <span class="slider-value-header" id="${valueId}">1.0</span>
                            </div>
                        </div>
                    `;

                    // Insert into the search container
                    var searchContainer = $('#' + tableId + '_wrapper .dt-search');
                    if (searchContainer.length) {
                        searchContainer.append(sliderHtml);
                    }
                }

                // Setup slider functionality with logarithmic scale
                function setupConnectionsSlider(sliderId, valueId, table) {
                    var slider = document.getElementById(sliderId);
                    var valueDisplay = document.getElementById(valueId);

                    if (slider && valueDisplay) {
                        // Initialize slider at position representing 1.0 connection (log10(1) = 0)
                        slider.value = Math.log10(1); // This equals 0

                        // Set initial display value
                        var initialValue = Math.pow(10, parseFloat(slider.value));
                        valueDisplay.textContent = initialValue.toFixed(1);

                        slider.addEventListener('input', function() {
                            // Convert from logarithmic scale to actual value
                            var actualValue = Math.pow(10, parseFloat(this.value));
                            valueDisplay.textContent = actualValue.toFixed(1);
                            table.draw();
                        });

                        // Trigger initial filter application
                        table.draw();
                    }
                }

                // Initialize upstream table
                {% if connectivity.upstream %}
                // Add custom search for upstream table only
                $.fn.dataTable.ext.search.push(createConnectionsFilter('upstream-table', 3));

                var upstreamTable = $('#upstream-table').DataTable({
                    "order": [[ 3, "desc" ]], // Sort by percentage column (descending)
                    "pageLength": -1, // Show all rows
                    "paging": false, // Disable pagination since we're using connections filter
                    "responsive": true,
                    "columnDefs": [
                        {
                            "targets": 4, // % of Input column
                            "type": "num-fmt",
                            "render": function(data, type, row) {
                                if (type === 'display') {
                                    return data;
                                }
                                return parseFloat(data.replace('%', '')) || 0;
                            }
                        }
                    ],
                    "drawCallback": function(settings) {
                        calculateCumulativePercentages(this.api(), 4, 5);
                    },
                    "initComplete": function(settings, json) {
                        // Create slider in header after table initialization
                        createConnectionsSliderInHeader('upstream-table', '{{- neuron_data.type -}}');
                        setupConnectionsSlider('upstream-connections-slider', 'upstream-slider-value', this.api());
                    }
                });
                {% endif %}

                // Initialize downstream table
                {% if connectivity.downstream %}
                // Add custom search for downstream table only
                $.fn.dataTable.ext.search.push(createConnectionsFilter('downstream-table', 3));

                var downstreamTable = $('#downstream-table').DataTable({
                    "order": [[ 3, "desc" ]], // Sort by percentage column (descending)
                    "pageLength": -1, // Show all rows
                    "paging": false, // Disable pagination since we're using connections filter
                    "responsive": true,
                    "columnDefs": [
                        {
                            "targets": 4, // % of Output column
                            "type": "num-fmt",
                            "render": function(data, type, row) {
                                if (type === 'display') {
                                    return data;
                                }
                                return parseFloat(data.replace('%', '')) || 0;
                            }
                        }
                    ],
                    "drawCallback": function(settings) {
                        calculateCumulativePercentages(this.api(), 4, 5);
                    },
                    "initComplete": function(settings, json) {
                        // Create slider in header after table initialization
                        createConnectionsSliderInHeader('downstream-table', '{{- neuron_data.type -}}');
                        setupConnectionsSlider('downstream-connections-slider', 'downstream-slider-value', this.api());
                    }
                });
                {% endif %}

                // Initialize ROI table with DataTables
                {% if roi_summary and roi_summary|length > 0 %}
                // Custom search function for ROI percentage filtering
                function createROIPercentageFilter(tableId) {
                    return function(settings, data, dataIndex) {
                        // Only apply this filter to the specific table it was created for
                        if (settings.sTableId !== tableId) return true;

                        var sliderId = settings.sTableId.replace('-table', '-percentage-slider');
                        var slider = document.getElementById(sliderId);
                        if (!slider) return true;

                        if (parseFloat(slider.value) == parseFloat(slider.min)){
                          return true;
                        }
                        // Convert from logarithmic scale to actual percentage threshold
                        var minPercentage = Math.pow(10, parseFloat(slider.value));
                        var inputPercentage = parseFloat(data[2]) || 0;  // % Input column
                        var outputPercentage = parseFloat(data[5]) || 0; // % Output column

                        // Show row if EITHER input OR output percentage meets threshold
                        return inputPercentage >= minPercentage || outputPercentage >= minPercentage;
                    };
                }

                // Create and insert percentage slider into DataTables header
                function createROIPercentageSliderInHeader(tableId) {
                    var sliderId = tableId.replace('-table', '-percentage-slider');
                    var valueId = tableId.replace('-table', '-slider-value');

                    // Create the slider HTML
                    var sliderHtml = `
                        <div class="connections-filter-header">
                            <label for="${sliderId}">Min % Input:</label>
                            <div class="slider-container-header">
                                <input type="range" id="${sliderId}" class="percentage-slider-header"
                                       min="-1.4" max="2" value="0.176" step="0.01">
                                <span class="slider-value-header" id="${valueId}">1.5%</span>
                            </div>
                        </div>
                    `;

                    // Insert into the search container
                    var searchContainer = $('#' + tableId + '_wrapper .dt-search');
                    if (searchContainer.length) {
                        searchContainer.append(sliderHtml);
                    }
                }

                // Setup ROI percentage slider functionality
                function setupROIPercentageSlider(sliderId, valueId, table) {
                    var slider = document.getElementById(sliderId);
                    var valueDisplay = document.getElementById(valueId);

                    if (slider && valueDisplay) {
                        // Initialize slider at 1.5% (log10(1.5) ≈ 0.176)
                        slider.value = Math.log10(1.5);
                        var initialValue = Math.pow(10, parseFloat(slider.value));
                        valueDisplay.textContent = initialValue.toFixed(1) + '%';

                        slider.addEventListener('input', function() {
                            // Convert from logarithmic scale to actual percentage
                            var actualValue = Math.pow(10, parseFloat(this.value));
                            valueDisplay.textContent = actualValue.toFixed(1) + '%';
                            table.draw();
                        });

                        // Trigger initial filter application
                        table.draw();
                    }
                }

                // Add custom search for ROI table
                $.fn.dataTable.ext.search.push(createROIPercentageFilter('roi-table'));

                var roiTable = $('#roi-table').DataTable({
                    "order": [[ 2, "desc" ]], // Sort by % Input column (descending)
                    "pageLength": -1, // Show all rows
                    "paging": false, // Disable pagination since we're using percentage filter
                    "responsive": true,
                    "columnDefs": [
                        {
                            "targets": [2, 5], // % Input and % Output columns
                            "type": "num-fmt",
                            "render": function(data, type, row, meta) {
                                if (type === 'display') {
                                    return data;
                                }
                                return parseFloat(data.replace('%', '')) || 0;
                            }
                        },
                        {
                            "targets": [1, 4], // Input and Output columns
                            "className": "dt-right"
                        }
                    ],
                    "drawCallback": function(settings) {
                        // Calculate cumulative percentages for both input and output
                        calculateCumulativePercentages(this.api(), 2, 3); // % Input -> Cumulative % Input
                        calculateCumulativePercentages(this.api(), 5, 6); // % Output -> Cumulative % Output
                    },
                    "initComplete": function(settings, json) {
                        // Create slider in header after table initialization
                        createROIPercentageSliderInHeader('roi-table');
                        setupROIPercentageSlider('roi-percentage-slider', 'roi-slider-value', this.api());
                    }
                });

                console.log('ROI table loaded with', {{- roi_summary|length -}}, 'primary ROIs');
                {% endif %}

                // Initialize Layer table with DataTables (simplified)
                {% if layer_analysis and layer_analysis.layers and layer_analysis.layers|length > 0 %}
                var layerTable = $('#layer-table').DataTable({
                    "order": [[ 0, "asc" ], [ 1, "asc" ], [ 2, "asc" ]],  // Sort by region, side, layer
                    "pageLength": -1, // Show all rows
                    "paging": false, // Disable pagination
                    "responsive": true,
                    "columnDefs": [
                        {"className": "dt-right", "targets": [3, 4, 5]},  // Right-align numeric columns
                        {"type": "num", "targets": [2, 3, 4, 5]}  // Treat as numbers for sorting
                    ],
                    "language": {
                        "search": "Search layers:",
                        "info": "Showing _START_ to _END_ of _TOTAL_ layers",
                        "infoEmpty": "No layers available",
                        "infoFiltered": "(filtered from _MAX_ total layers)"
                    }
                });
                console.log('Layer table loaded with', {{- layer_analysis.layers|length -}}, 'layers');
                {% endif %}

                // Initialize Column table with DataTables (simplified)
                {% if column_analysis and column_analysis.columns and column_analysis.columns|length > 0 %}
                var columnTable = $('#column-table').DataTable({
                    "order": [[ 0, "asc" ], [ 1, "asc" ], [ 2, "asc" ], [ 3, "asc" ]],  // Sort by region, side, row, col
                    "pageLength": 25,
                    "responsive": true,
                    "columnDefs": [
                        {"className": "dt-right", "targets": [4, 5]},  // Right-align numeric columns
                        {"type": "num", "targets": [4, 5]}  // Treat as numbers for sorting
                    ],
                    "language": {
                        "search": "Search columns:",
                        "lengthMenu": "Show _MENU_ columns per page",
                        "info": "Showing _START_ to _END_ of _TOTAL_ columns",
                        "infoEmpty": "No columns available",
                        "infoFiltered": "(filtered from _MAX_ total columns)"
                    }
                });
                console.log('Column table loaded with', {{- column_analysis.columns|length -}}, 'columns');
                {% endif %}

                // Layer innervation enhancement notice (no additional tables needed)
                {% if connectivity and connectivity.regional_connections and connectivity.regional_connections.enhanced_info %}
                console.log('Layer innervation detected - enhanced analysis available');
                {% endif %}




                // Fast tooltip support for inline SVGs (--embed mode)
                function initializeInlineSVGTooltips() {
                    // Create tooltip element for inline SVGs
                    const tooltip = document.createElement('div');
                    tooltip.className = 'svg-tooltip inline-svg-tooltip';
                    document.body.appendChild(tooltip);

                    // Find all inline SVG elements with paths that have titles
                    const inlineSVGs = document.querySelectorAll('svg');

                    inlineSVGs.forEach(svg => {
                        const paths = svg.querySelectorAll('path[fill] title');

                        paths.forEach(titleElement => {
                            const path = titleElement.parentNode;
                            const tooltipText = titleElement.textContent;

                            if (tooltipText.trim()) {
                                path.addEventListener('mouseenter', function(e) {
                                    // Hide native title immediately
                                    titleElement.textContent = '';

                                    // Show custom tooltip
                                    tooltip.textContent = tooltipText;
                                    tooltip.style.display = 'block';

                                    // Position tooltip near mouse
                                    const updateTooltipPosition = (event) => {
                                        const x = event.clientX + window.scrollX;
                                        const y = event.clientY + window.scrollY;
                                        tooltip.style.left = (x + 10) + 'px';
                                        tooltip.style.top = (y - 10) + 'px';
                                    };

                                    updateTooltipPosition(e);

                                    // Follow mouse movement
                                    const mouseMoveHandler = updateTooltipPosition;
                                    document.addEventListener('mousemove', mouseMoveHandler);

                                    // Store cleanup function
                                    path._inlineTooltipCleanup = () => {
                                        document.removeEventListener('mousemove', mouseMoveHandler);
                                    };
                                });

                                path.addEventListener('mouseleave', function() {
                                    // Restore native title
                                    titleElement.textContent = tooltipText;

                                    // Hide custom tooltip
                                    tooltip.style.display = 'none';

                                    // Clean up mouse move listener
                                    if (path._inlineTooltipCleanup) {
                                        path._inlineTooltipCleanup();
                                        delete path._inlineTooltipCleanup;
                                    }
                                });
                            }
                        });
                    });
                }

                function initializeAbbrTooltips() {
                    // Create tooltip element for abbr tags (reuse existing svg-tooltip styles)
                    const tooltip = document.createElement('div');
                    tooltip.className = 'svg-tooltip abbr-tooltip';
                    document.body.appendChild(tooltip);

                    // Find all abbr elements with title attributes
                    const abbrElements = document.querySelectorAll('abbr[title]');

                    abbrElements.forEach(abbr => {
                        const tooltipText = abbr.getAttribute('title');

                        if (tooltipText && tooltipText.trim()) {
                            // Remove native title to prevent default browser tooltip
                            abbr.removeAttribute('title');
                            abbr.setAttribute('data-original-title', tooltipText);

                            abbr.addEventListener('mouseenter', function(e) {
                                // Show custom tooltip
                                tooltip.textContent = tooltipText;
                                tooltip.style.display = 'block';

                                // Position tooltip near mouse
                                const updateTooltipPosition = (event) => {
                                    const x = event.clientX + window.scrollX;
                                    const y = event.clientY + window.scrollY;
                                    tooltip.style.left = (x + 10) + 'px';
                                    tooltip.style.top = (y - 10) + 'px';
                                };

                                updateTooltipPosition(e);

                                // Follow mouse movement
                                const mouseMoveHandler = updateTooltipPosition;
                                document.addEventListener('mousemove', mouseMoveHandler);

                                // Store cleanup function
                                abbr._abbrTooltipCleanup = () => {
                                    document.removeEventListener('mousemove', mouseMoveHandler);
                                };
                            });

                            abbr.addEventListener('mouseleave', function() {
                                // Hide custom tooltip
                                tooltip.style.display = 'none';

                                // Clean up mouse move listener
                                if (abbr._abbrTooltipCleanup) {
                                    abbr._abbrTooltipCleanup();
                                    delete abbr._abbrTooltipCleanup;
                                }
                            });
                        }
                    });
                }

                // Initialize tooltips with slight delay to ensure DOM is ready
                setTimeout(() => {
                    initializeInlineSVGTooltips();
                    initializeAbbrTooltips();
                }, 100);
            });
        </script>
    </body>
</html>
