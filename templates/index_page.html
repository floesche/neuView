{% extends "base.html" %}

{% block title %}{{ config.html.title_prefix }} - Index{% endblock %}

{% block header %}
<div class="neuron-header-bar">
  <div class="header-flex">
    <div class="header-left">
      <nav class="nav-links">
        <a href="index.html" class="active">Home</a>
        <a href="cell_types.html">Cell Types</a>
        <a href="webpages_glossary.html">Glossary</a>
      </nav>
    </div>
    <div class="header-center">
      <span class="brand">Cell Type Catalog</span>
    </div>
    <div class="header-right">
      <form class="search-form">
        <input id="menulines" type="text" placeholder="Filter by neuron type name..." />
      </form>
      <a href="https://github.com/reiserlab/male-drosophila-visual-system-connectome-code" class="icon-link"><img src="https://icongr.am/simple/github.svg?size=32&color=333333" alt="icon"></a>
      <a href="https://www.youtube.com/@ReiserLab" class="icon-link"><img src="https://icongr.am/simple/youtube.svg?size=32&color=cc0000" alt="icon"></a>
      <nav class="nav-links"><a href="https://{{- config.neuprint.server -}}/?dataset={{- config.neuprint.dataset -}}" class="nav-link">neuPrint</a></nav>
    </div>
  </div>
  <div class="header-title">
    <div class="title-container">
      <h1 id="top">
        Neuron Type Index
        <span class="counter">{{ total_types }}</span> type{{ 's' if total_types > 1 else '' }}
      </h1>
    </div>
  </div>
</div>

<!-- Include neuron search functionality -->
<script src="static/js/neuron-search.js"></script>
{% endblock %}

{% block content %}
<div class="index-container">
  <div class="index-intro">
    <p class="intro-text">
      This page lists all available neuron types in the dataset. Click on the neuron type name to view the combined data,
      or click on the soma side indicators (L, R, M) to view side-specific pages.
    </p>
    <div class="stats-summary">
      <span class="stat-item">
        <strong>{{ total_types }}</strong> neuron types
      </span>
      <span class="stat-item">
        Generated: <time datetime="{{ generation_time.isoformat() }}">{{ generation_time.strftime('%Y-%m-%d %H:%M') }}</time>
      </span>
    </div>
  </div>

  <div class="filter-controls">
    <div class="row middle-xs">
      <div class="col-xs-12 col-sm-3 col-md-2">
        <label for="name-filter" class="filter-label">Filter by name:</label>
        <div class="filter-input-container">
          <input type="text" id="name-filter" class="filter-input" placeholder="Enter neuron type name..." />
          <button type="button" id="clear-name-filter" class="clear-input-btn" title="Clear name filter">&times;</button>
        </div>
      </div>
      
      <div class="col-xs-6 col-sm-2 col-md-2">
        <label for="soma-filter" class="filter-label">Sides:</label>
        <select id="soma-filter" class="filter-dropdown">
          <option value="all">All</option>
          <option value="both">Both Sides</option>
          <option value="left">Left Side</option>
          <option value="right">Right Side</option>
          <option value="middle">Middle</option>
        </select>
      </div>
      
      <div class="col-xs-6 col-sm-2 col-md-2">
        <label for="roi-filter" class="filter-label">ROI:</label>
        <select id="roi-filter" class="filter-dropdown">
          <option value="all">All ROIs</option>
        </select>
      </div>
      
      <div class="col-xs-6 col-sm-2 col-md-2">
        <label for="region-filter" class="filter-label">Region:</label>
        <select id="region-filter" class="filter-dropdown">
          <option value="all">All Regions</option>
        </select>
      </div>
      
      <div class="col-xs-6 col-sm-3 col-md-4">
        <span id="result-count" class="result-count"></span>
      </div>
    </div>
  </div>

  <div id="no-results-message" class="no-results-message" style="display: none;">
    <div class="no-results-content">
      <h3>No neuron types found</h3>
      <p>No neuron types match the current filter criteria. Try selecting a different filter or clearing the search.</p>
    </div>
  </div>

  <div id="filtered-results-container"></div>
  
  <!-- Hidden container to store original cards structure -->
  <div id="original-cards-container" style="display: none;">
    {% for group in grouped_neuron_types %}
    <div class="neuron-section" data-region="{{ group.parent_roi }}">
      <h2 class="section-title">{{ group.parent_roi }}</h2>
      <div class="section-description">
        {% if group.parent_roi == 'Other' %}
          <p>Neuron types without clear parent ROI classification</p>
        {% elif group.parent_roi == 'OL' %}
          <p>Optic Lobe - Visual processing neurons</p>
        {% elif group.parent_roi == 'Central' %}
          <p>Central Brain - Higher-order processing and integration</p>
        {% elif group.parent_roi == 'VNC' %}
          <p>Ventral Nerve Cord - Motor control and sensory processing</p>
        {% else %}
          <p>{{ group.neuron_types|length }} neuron type{{ 's' if group.neuron_types|length > 1 else '' }} in this region</p>
        {% endif %}
      </div>
      
      {% for neuron in group.neuron_types %}
      <div class="neuron-card-wrapper col-xs-12 col-sm-6 col-md-4 col-lg-3" data-region="{{ group.parent_roi }}" data-rois="{% if neuron.roi_summary %}{{ neuron.roi_summary|map(attribute='name')|join(',') }}{% endif %}" data-parent-roi="{{ neuron.parent_roi if neuron.parent_roi else '' }}">
        <div class="neuron-card">
        <div class="card-header">
          {% if neuron.both_url %}
            <a href="{{ neuron.both_url }}" class="neuron-name-link">{{ neuron.name }}</a>
          {% else %}
            <span class="neuron-name">{{ neuron.name }}</span>
          {% endif %}
          
          <div class="soma-indicators">
            {% if neuron.has_left or neuron.has_right or neuron.has_middle %}
              <span class="soma-label">(</span>
              {% if neuron.has_left %}
                <a href="{{ neuron.left_url }}" class="soma-link left" title="View {{ neuron.name }} left side">L</a>
              {% endif %}
              {% if neuron.has_left and (neuron.has_right or neuron.has_middle) %}<span class="soma-separator">, </span>{% endif %}
              {% if neuron.has_right %}
                <a href="{{ neuron.right_url }}" class="soma-link right" title="View {{ neuron.name }} right side">R</a>
              {% endif %}
              {% if neuron.has_right and neuron.has_middle %}<span class="soma-separator">, </span>{% endif %}
              {% if neuron.has_middle %}
                <a href="{{ neuron.middle_url }}" class="soma-link middle" title="View {{ neuron.name }} middle">M</a>
              {% endif %}
              <span class="soma-label">)</span>
            {% endif %}
          </div>
        </div>
        
        <div class="card-info">
          <div class="tag-list">
            {% if neuron.parent_roi %}
            <span class="roi-tag parent-roi">{{ neuron.parent_roi }}</span>
            {% endif %}
            {% if neuron.has_both %}
            <span class="view-indicator both">Both Sides</span>
            {% endif %}
            {% if neuron.has_left %}
            <span class="view-indicator left">Left</span>
            {% endif %}
            {% if neuron.has_right %}
            <span class="view-indicator right">Right</span>
            {% endif %}
            {% if neuron.has_middle %}
            <span class="view-indicator middle">Middle</span>
            {% endif %}
            {% for roi in neuron.roi_summary %}
            <span class="roi-tag">{{ roi.name }}</span>
            {% endfor %}
          </div>
        </div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% endfor %}
  </div>
  
  <!-- Hidden container for filtered out cards -->
  <div id="filtered-cards-container" style="display: none;"></div>
</div>

<style>
.index-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
}

.index-intro {
  background: #f8f9fa;
  padding: 20px;
  border-radius: 8px;
  margin-bottom: 20px;
  border-left: 4px solid #007bff;
}

.filter-controls {
  background: white;
  padding: 20px;
  border-radius: 8px;
  border: 1px solid #e9ecef;
  margin-bottom: 30px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.filter-controls .row {
  margin: 0;
}

.filter-controls [class*="col-"] {
  padding-left: 10px;
  padding-right: 10px;
}

.filter-label {
  font-weight: 600;
  color: #495057;
  font-size: 14px;
  display: block;
  margin-bottom: 5px;
}

.filter-dropdown {
  padding: 8px 12px;
  border: 1px solid #ced4da;
  border-radius: 4px;
  background: white;
  color: #495057;
  font-size: 1em;
  cursor: pointer;
  transition: border-color 0.2s, box-shadow 0.2s;
  width: 100%;
}

.filter-dropdown:hover {
  border-color: #007bff;
}

.filter-dropdown:focus {
  outline: none;
  border-color: #007bff;
  box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.filter-input {
  padding: 8px 12px;
  border: 1px solid #ced4da;
  border-radius: 4px;
  font-size: 14px;
  background-color: white;
  transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
  width: 100%;
}

.filter-input:hover {
  border-color: #adb5bd;
}

.filter-input:focus {
  outline: none;
  border-color: #007bff;
  box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.filter-input-container {
  position: relative;
  display: block;
  width: 100%;
}

.clear-input-btn {
  position: absolute;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  font-size: 18px;
  color: #6c757d;
  cursor: pointer;
  padding: 0;
  width: 20px;
  height: 20px;
  display: none;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: all 0.2s ease;
}

.clear-input-btn:hover {
  background-color: #e9ecef;
  color: #495057;
}

.filter-input-container input:not([value=""]) + .clear-input-btn {
  display: flex;
}

.filter-input-container.has-content .clear-input-btn {
  display: flex;
}

.result-count {
  font-size: 14px;
  color: #6c757d;
  font-weight: 500;
  margin-top: 25px;
  display: block;
}

.no-results-message {
  background: #f8f9fa;
  border: 2px dashed #dee2e6;
  border-radius: 8px;
  padding: 40px 20px;
  text-align: center;
  margin-bottom: 30px;
  color: #6c757d;
}

.no-results-content h3 {
  margin: 0 0 15px 0;
  color: #495057;
  font-size: 1.3em;
}

.no-results-content p {
  margin: 0;
  font-size: 1em;
  line-height: 1.5;
}

.intro-text {
  font-size: 1.1em;
  line-height: 1.6;
  margin-bottom: 15px;
  color: #495057;
}

.stats-summary {
  display: flex;
  gap: 30px;
  font-size: 0.95em;
  color: #6c757d;
}

.stat-item {
  display: flex;
  align-items: center;
}

.neuron-section {
  margin-bottom: 40px;
  border: 1px solid #e9ecef;
  border-radius: 8px;
  background: white;
  overflow: hidden;
}

.section-title {
  background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
  color: white;
  margin: 0;
  padding: 20px 25px;
  font-size: 1.4em;
  font-weight: 600;
  border-bottom: 3px solid #0056b3;
}

.section-description {
  background: #f8f9fa;
  padding: 15px 25px;
  border-bottom: 1px solid #e9ecef;
}

.section-description p {
  margin: 0;
  color: #6c757d;
  font-size: 1em;
  line-height: 1.5;
}

.neuron-section .row {
  margin: 0;
  padding: 25px;
}

.neuron-section [class*="col-"] {
  padding: 10px;
  margin-bottom: 20px;
}

.neuron-card {
  background: white;
  border: 1px solid #e9ecef;
  border-radius: 8px;
  padding: 20px;
  transition: box-shadow 0.2s, transform 0.2s;
  position: relative;
  height: 100%;
  display: flex;
  flex-direction: column;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.neuron-card:hover {
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  transform: translateY(-2px);
}

.card-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 15px;
}

.neuron-name-link {
  font-size: 1.3em;
  font-weight: 600;
  color: #007bff;
  text-decoration: none;
  transition: color 0.2s;
}

.neuron-name-link:hover {
  color: #0056b3;
  text-decoration: underline;
}

.neuron-name {
  font-size: 1.3em;
  font-weight: 600;
  color: #495057;
}

.soma-indicators {
  display: flex;
  align-items: center;
  font-size: 1.1em;
}

.soma-label {
  color: #6c757d;
}

.soma-separator {
  color: #6c757d;
  margin: 0 2px;
}

.soma-link {
  color: #007bff;
  text-decoration: none;
  font-weight: 500;
  padding: 2px 4px;
  border-radius: 3px;
  transition: background-color 0.2s, color 0.2s;
}

.soma-link:hover {
  background-color: #e9ecef;
  color: #343a40;
  text-decoration: none;
  transform: translateY(-1px);
}



.soma-link.left:hover {
  background-color: #28a745;
}

.soma-link.right:hover {
  background-color: #dc3545;
}

.soma-link.middle:hover {
  background-color: #ffc107;
  color: #212529;
}

.card-info {
  border-top: 1px solid #e9ecef;
  padding-top: 15px;
  margin-top: auto;
  flex-shrink: 0;
}

.tag-list {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.view-indicator {
  font-size: 0.85em;
  padding: 4px 8px;
  border-radius: 12px;
  color: white;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
}

.view-indicator.both {
  background-color: #6f42c1;
}

.view-indicator.both:hover {
  background-color: #5a32a3;
  transform: translateY(-1px);
}

.view-indicator.both.selected {
  background-color: #4e2a87;
  box-shadow: 0 2px 4px rgba(111, 66, 193, 0.3);
}

.view-indicator.left {
  background-color: #28a745;
}

.view-indicator.left:hover {
  background-color: #218838;
  transform: translateY(-1px);
}

.view-indicator.left.selected {
  background-color: #1e7e34;
  box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
}

.view-indicator.right {
  background-color: #dc3545;
}

.view-indicator.right:hover {
  background-color: #c82333;
  transform: translateY(-1px);
}

.view-indicator.right.selected {
  background-color: #bd2130;
  box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);
}

.view-indicator.middle {
  background-color: #ffc107;
  color: #212529;
}

.view-indicator.middle:hover {
  background-color: #e0a800;
  transform: translateY(-1px);
}

.view-indicator.middle.selected {
  background-color: #d39e00;
  box-shadow: 0 2px 4px rgba(255, 193, 7, 0.3);
}



.roi-tag {
  font-size: 0.75em;
  padding: 2px 6px;
  background-color: #f8f9fa;
  border: 1px solid #e9ecef;
  border-radius: 10px;
  color: #495057;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
}

.roi-tag.selected {
  background-color: #28a745;
  color: white;
  border-color: #1e7e34;
  font-weight: 600;
}

.roi-tag:hover {
  background-color: #e9ecef;
  color: #343a40;
  transform: translateY(-1px);
  transition: all 0.2s ease;
}

.roi-tag.selected:hover {
  background-color: #1e7e34;
  color: white;
  transform: translateY(-1px);
}

.roi-tag.parent-roi {
  background-color: #007bff;
  color: white;
  border: 1px solid #0056b3;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
}

.roi-tag.parent-roi:hover {
  background-color: #0056b3;
  color: white;
  transform: translateY(-1px);
  transition: all 0.2s ease;
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .neuron-section .row {
    padding: 15px 10px;
    margin: 0;
  }
  
  .neuron-section [class*="col-"] {
    padding: 8px;
    margin-bottom: 20px;
  }
  
  .neuron-card {
    padding: 15px;
    margin-bottom: 0;
  }
  
  .section-title {
    padding: 15px 20px;
    font-size: 1.2em;
  }
  
  .section-description {
    padding: 12px 20px;
  }
  
  .stats-summary {
    flex-direction: column;
    gap: 10px;
  }
  
  .card-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 10px;
  }
  
  .filter-controls .row {
    flex-direction: column;
  }
  
  .filter-controls [class*="col-"] {
    margin-bottom: 15px;
    padding-left: 0 !important;
    padding-right: 0 !important;
  }
  
  .filter-controls [class*="col-"]:last-child {
    margin-bottom: 0;
  }
  
  .result-count {
    text-align: left;
    margin-top: 5px;
  }
  
  .tag-list {
    gap: 6px;
  }
  
  .roi-tag,
  .view-indicator {
    font-size: 0.7em;
    padding: 3px 6px;
  }
}

/* Search functionality integration */
#filtered-cards-container {
  display: none;
}
</style>
{% endblock %}

{% block footer %}
{% include "sections/footer.html" %}
{% endblock %}

{% block extra_scripts %}
<!-- jQuery for search functionality -->
<script src="static/js/jquery-3.7.1.min.js"></script>

<script>
// Enhanced search functionality for the index page
$(document).ready(function() {
  const searchInput = $('#menulines');
  const nameFilter = $('#name-filter');
  const somaFilter = $('#soma-filter');
  const roiFilter = $('#roi-filter');
  const regionFilter = $('#region-filter');
  const neuronCards = $('.neuron-card-wrapper');
  
  // Initialize the display on page load
  setTimeout(rebuildFilteredView, 100);
  
  // Populate ROI filter dropdown
  function populateRoiFilter() {
    const allRois = new Set();
    
    neuronCards.each(function() {
      const cardRois = $(this).data('rois');
      const parentRoi = $(this).data('parent-roi');
      
      if (cardRois) {
        cardRois.split(',').forEach(roi => {
          if (roi.trim()) {
            allRois.add(roi.trim());
          }
        });
      }
      
      if (parentRoi && parentRoi.trim()) {
        allRois.add(parentRoi.trim());
      }
    });
    
    const sortedRois = Array.from(allRois).sort();
    sortedRois.forEach(roi => {
      roiFilter.append(new Option(roi, roi));
    });
  }
  
  // Populate region filter dropdown
  function populateRegionFilter() {
    const allRegions = new Set();
    
    $('#original-cards-container .neuron-section').each(function() {
      const sectionTitle = $(this).find('.section-title').text().trim();
      if (sectionTitle) {
        allRegions.add(sectionTitle);
      }
    });
    
    const sortedRegions = Array.from(allRegions).sort();
    // Put 'Other' at the end if it exists
    const otherIndex = sortedRegions.indexOf('Other');
    if (otherIndex > -1) {
      const other = sortedRegions.splice(otherIndex, 1)[0];
      sortedRegions.push(other);
    }
    
    sortedRegions.forEach(region => {
      regionFilter.append(new Option(region, region));
    });
  }
  
  // Initialize filters
  populateRoiFilter();
  populateRegionFilter();
  
  // Initialize highlighting on page load
  updateHighlighting();

  // Add click handlers for ROI tags using event delegation
  $(document).on('click', '.roi-tag', function(e) {
    e.preventDefault();
    const roiName = $(this).text().trim();
    const currentRoiFilter = roiFilter.val();
    
    // If clicking on the currently selected ROI, reset the filter
    if (currentRoiFilter === roiName) {
      roiFilter.val('all');
    } else {
      roiFilter.val(roiName);
    }
    
    // Apply filters and update highlighting
    applyFilters();
    
    // Keep focus on the card that was clicked
    const card = $(this).closest('.neuron-card-wrapper');
    setTimeout(() => {
      if (card.length && card[0].scrollIntoView) {
        card[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }, 100);
  });

  // Add click handlers for view indicator elements using event delegation
  $(document).on('click', '.view-indicator', function(e) {
    e.preventDefault();
    const clickedElement = $(this);
    let filterValue = 'all';
    
    // Determine which filter value based on the clicked element's classes
    if (clickedElement.hasClass('left')) {
      filterValue = 'left';
    } else if (clickedElement.hasClass('right')) {
      filterValue = 'right';
    } else if (clickedElement.hasClass('middle')) {
      filterValue = 'middle';
    } else if (clickedElement.hasClass('both')) {
      filterValue = 'both';
    }
    
    const currentSomaFilter = somaFilter.val();
    
    // If clicking on the currently selected filter, reset it
    if (currentSomaFilter === filterValue) {
      somaFilter.val('all');
    } else {
      somaFilter.val(filterValue);
    }
    
    // Apply filters and update highlighting
    applyFilters();
    
    // Keep focus on the card that was clicked
    const card = $(this).closest('.neuron-card-wrapper');
    setTimeout(() => {
      if (card.length && card[0].scrollIntoView) {
        card[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }, 100);
  });

  // Function to update highlighting based on current filters
  function updateHighlighting() {
    const currentRoiFilter = roiFilter.val();
    const currentSomaFilter = somaFilter.val();
    
    // Update ROI tag highlighting
    $('#filtered-results-container .roi-tag').removeClass('selected');
    if (currentRoiFilter !== 'all') {
      $('#filtered-results-container .roi-tag').each(function() {
        if ($(this).text().trim() === currentRoiFilter) {
          $(this).addClass('selected');
        }
      });
    }
    
    // Update view indicator highlighting
    $('#filtered-results-container .view-indicator').removeClass('selected');
    if (currentSomaFilter !== 'all') {
      $('#filtered-results-container .view-indicator').each(function() {
        const indicator = $(this);
        let shouldHighlight = false;
        
        if (currentSomaFilter === 'left' && indicator.hasClass('left')) {
          shouldHighlight = true;
        } else if (currentSomaFilter === 'right' && indicator.hasClass('right')) {
          shouldHighlight = true;
        } else if (currentSomaFilter === 'middle' && indicator.hasClass('middle')) {
          shouldHighlight = true;
        } else if (currentSomaFilter === 'both' && indicator.hasClass('both')) {
          shouldHighlight = true;
        }
        
        if (shouldHighlight) {
          indicator.addClass('selected');
        }
      });
    }
  }

  // Add event handlers for dropdown changes and input fields
  nameFilter.on('input', function() {
    // Sync with header search
    searchInput.val($(this).val());
    applyFilters();
    updateHighlighting();
  });

  // Add clear button functionality for name filter
  $('#clear-name-filter').on('click', function() {
    nameFilter.val('');
    searchInput.val('');
    nameFilter.trigger('input');
    nameFilter.focus();
  });

  // Show/hide clear button based on input content
  nameFilter.on('input', function() {
    const container = $(this).parent('.filter-input-container');
    if ($(this).val().trim() !== '') {
      container.addClass('has-content');
    } else {
      container.removeClass('has-content');
    }
  });
  
  // Initialize clear button visibility on page load
  if (nameFilter.val().trim() !== '') {
    nameFilter.parent('.filter-input-container').addClass('has-content');
  }

  // Add keyboard support for name filter
  nameFilter.on('keydown', function(e) {
    if (e.key === 'Escape') {
      $(this).val('');
      searchInput.val('');
      $(this).trigger('input');
    }
  });

  somaFilter.on('change', function() {
    applyFilters();
    updateHighlighting();
  });

  roiFilter.on('change', function() {
    applyFilters();
    updateHighlighting();
  });

  regionFilter.on('change', function() {
    applyFilters();
    updateHighlighting();
  });

  searchInput.on('input', function() {
    // Sync with name filter
    nameFilter.val($(this).val());
    nameFilter.trigger('input');
  });

  // Function to rebuild the filtered view by moving cards between containers
  function rebuildFilteredView() {
    const nameTerm = nameFilter.val().toLowerCase().trim();
    const selectedFilter = somaFilter.val();
    const selectedRoi = roiFilter.val();
    const selectedRegion = regionFilter.val();
    
    // Clear the results container
    $('#filtered-results-container').empty();
    
    // Group filtered cards by region
    const regionGroups = {};
    let visibleCount = 0;
    const totalCount = neuronCards.length;
    
    // Collect all matching cards
    neuronCards.each(function() {
      const cardWrapper = $(this);
      const card = cardWrapper.find('.neuron-card');
      const neuronName = card.find('.neuron-name-link, .neuron-name').text().toLowerCase();
      const availableViews = card.find('.view-indicator');
      const cardRois = cardWrapper.data('rois') ? cardWrapper.data('rois').split(',') : [];
      const parentRoi = cardWrapper.data('parent-roi');
      const region = cardWrapper.data('region');
      
      // Check name filter
      const matchesName = nameTerm === '' || neuronName.includes(nameTerm);
      
      // Check soma side filter
      let matchesFilter = true;
      if (selectedFilter !== 'all') {
        matchesFilter = false;
        availableViews.each(function() {
          const indicator = $(this);
          if (selectedFilter === 'both' && indicator.hasClass('both')) {
            matchesFilter = true;
          } else if (selectedFilter === 'left' && indicator.hasClass('left')) {
            matchesFilter = true;
          } else if (selectedFilter === 'right' && indicator.hasClass('right')) {
            matchesFilter = true;
          } else if (selectedFilter === 'middle' && indicator.hasClass('middle')) {
            matchesFilter = true;
          }
        });
      }
      
      // Check ROI filter
      let matchesRoi = true;
      if (selectedRoi !== 'all') {
        matchesRoi = cardRois.includes(selectedRoi) || (parentRoi && parentRoi === selectedRoi);
      }
      
      // Check region filter
      let matchesRegion = selectedRegion === 'all' || region === selectedRegion;
      
      // If card matches all filters, add to appropriate region group
      if (matchesName && matchesFilter && matchesRoi && matchesRegion) {
        if (!regionGroups[region]) {
          regionGroups[region] = [];
        }
        regionGroups[region].push(cardWrapper);
        visibleCount++;
      }
    });
    
    // Build the filtered results
    const resultsContainer = $('#filtered-results-container');
    
    // Get region order from original sections
    $('#original-cards-container .neuron-section').each(function() {
      const region = $(this).data('region');
      const sectionTitle = $(this).find('.section-title').clone();
      const sectionDescription = $(this).find('.section-description').clone();
      
      if (regionGroups[region] && regionGroups[region].length > 0) {
        // Create section
        const sectionDiv = $('<div class="neuron-section"></div>');
        sectionDiv.append(sectionTitle);
        sectionDiv.append(sectionDescription);
        
        // Create row for cards
        const rowDiv = $('<div class="row"></div>');
        
        // Add cards to row
        regionGroups[region].forEach(function(cardWrapper) {
          rowDiv.append(cardWrapper.clone());
        });
        
        sectionDiv.append(rowDiv);
        resultsContainer.append(sectionDiv);
      }
    });
    
    // Show/hide no results message and update count
    if (visibleCount === 0) {
      $('#no-results-message').show();
      $('#result-count').text('0 of ' + totalCount + ' types shown');
    } else {
      $('#no-results-message').hide();
      if (visibleCount === totalCount) {
        $('#result-count').text('Showing all ' + totalCount + ' types');
      } else {
        $('#result-count').text(visibleCount + ' of ' + totalCount + ' types shown');
      }
    }
  }

  function applyFilters() {
    rebuildFilteredView();
    setTimeout(updateHighlighting, 50);
  }
  
  // Initialize count display
  applyFilters();

  // Clear search on escape key
  searchInput.on('keydown', function(e) {
    if (e.key === 'Escape') {
      $(this).val('');
      applyFilters();
    }
  });
});
</script>
{% endblock %}
